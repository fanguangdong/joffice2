ConferenceForm=Ext.extend(Ext.Window,{store:null,gridPanel:null,formPanel:null,basePanel:null,contextPanel:null,jonerPanel:null,grantPanel:null,filePanel:null,buttons:null,constructor:function(a){Ext.applyIf(this,a);this.initUIComponents();ConferenceForm.superclass.constructor.call(this,{id:"ConferenceFormWin",layout:"fit",iconCls:"menu-conference",items:this.formPanel,modal:true,maximizable:true,minWidth:800,width:730,height:650,minHeight:650,autoScroll:false,title:"编辑会议内容",buttonAlign:"center",buttons:this.buttons,keys:{key:Ext.EventObject.ENTER,fn:this.send.createCallback(this.formPanel,this),scope:this}});},initUIComponents:function(){this.basePanel=new Ext.form.FieldSet({id:"conference.basePanel",title:"会议信息",layout:"form",border:true,items:[{layout:"column",columnWidth:1,border:false,defaults:{border:false},items:[{layout:"form",columnWidth:0.5,defaults:{width:"100%"},items:[{xtype:"hidden",name:"conference.confId",value:this.confId!=null?this.confId:""},{anchor:"99%",xtype:"textfield",name:"conference.confTopic",fieldLabel:"会议标题",allowBlank:false,maxLength:128},{xtype:"hidden",name:"conference.typeId"},{anchor:"99%",xtype:"combo",name:"conference.confProperty",fieldLabel:"会议类型",valueField:"typeId",displayField:"typeName",mode:"local",editable:false,triggerAction:"all",forceSelection:true,allowBlank:false,store:new Ext.data.SimpleStore({url:__ctxPath+"/admin/getTypeAllConference.do",autoLoad:true,fields:["typeId","typeName"]}),listeners:{select:function(d,a,b){var c=Ext.getCmp("conference.basePanel");c.getCmpByName("conference.typeId").setValue(d.getValue());}}},{anchor:"99%",name:"conference.feeBudget",fieldLabel:"经费(元)",text:"0",xtype:"numberfield",maxLength:21},{anchor:"99%",fieldLabel:"留言方式",xtype:"container",layout:"column",border:false,defaults:{border:false,xtype:"checkbox"},items:[{columnWidth:0.5,boxLabel:"普通留言",name:"conference.isEmail",inputValue:1,checked:true},{columnWidth:0.5,boxLabel:"手机留言",name:"conference.isMobile",inputValue:1}]}]},{layout:"form",columnWidth:0.5,defaults:{width:"100%"},items:[{xtype:"hidden",name:"conference.roomId"},{anchor:"99%",xtype:"combo",name:"conference.roomName",fieldLabel:"会议室名称",valueField:"roomId",displayField:"roomName",mode:"local",editable:false,triggerAction:"all",forceSelection:true,allowBlank:false,store:new Ext.data.SimpleStore({url:__ctxPath+"/admin/getBoardrooConference.do",autoLoad:true,fields:["roomId","roomName"]}),listeners:{select:function(d,a,b){var c=Ext.getCmp("conference.basePanel");c.getCmpByName("conference.roomId").setValue(d.getValue());c.getCmpByName("roomName").setValue(d.getRawValue());c.getCmpByName("conference.roomLocation").setValue(d.getRawValue());}}},{anchor:"99%",xtype:"textfield",readOnly:true,fieldLabel:"会议室",name:"roomName"},{anchor:"99%",xtype:"textfield",fieldLabel:"地址",name:"conference.roomLocation",allowBlank:false,maxLength:128},{anchor:"99%",xtype:"radiogroup",fieldLabel:"重要级别",border:false,items:[{boxLabel:"普通",name:"conference.importLevel",inputValue:0,checked:true},{boxLabel:"重要",name:"conference.importLevel",inputValue:1}]}]}]}]});this.jonerPanel=new Ext.form.FieldSet({id:"conference.jonerPanel",title:"参加人员",layout:"form",border:true,items:[{anchor:"100%",fieldLabel:"主持人",xtype:"container",layout:"column",border:false,items:[{xtype:"hidden",name:"conference.compere"},{columnWidth:1,anchor:"90%",xtype:"textfield",name:"conference.compereName",readOnly:true,allowBlank:false,maxLength:256},{xtype:"button",text:"请选择",iconCls:"btn-user-sel",handler:function(){UserSelector.getView(function(a,c){var b=Ext.getCmp("conference.jonerPanel");b.getCmpByName("conference.compere").setValue(a);b.getCmpByName("conference.compereName").setValue(c);}).show();}}]},{anchor:"100%",fieldLabel:"记录人",xtype:"container",layout:"column",border:false,items:[{xtype:"hidden",name:"conference.recorder"},{columnWidth:1,anchor:"90%",xtype:"textfield",name:"conference.recorderName",readOnly:true,allowBlank:false,maxLength:256},{xtype:"button",text:"请选择",iconCls:"btn-user-sel",handler:function(){UserSelector.getView(function(a,c){var b=Ext.getCmp("conference.jonerPanel");b.getCmpByName("conference.recorder").setValue(a);b.getCmpByName("conference.recorderName").setValue(c);}).show();}}]},{anchor:"100%",fieldLabel:"参加人",xtype:"container",layout:"column",border:false,items:[{xtype:"hidden",name:"conference.attendUsers"},{columnWidth:1,anchor:"90%",xtype:"textfield",name:"conference.attendUsersName",readOnly:true,allowBlank:false,maxLength:4000},{xtype:"button",text:"请选择",iconCls:"btn-user-sel",handler:function(){UserSelector.getView(function(a,c){var b=Ext.getCmp("conference.jonerPanel");b.getCmpByName("conference.attendUsers").setValue(a);b.getCmpByName("conference.attendUsersName").setValue(c);}).show();}}]}]});this.grantPanel=new Ext.form.FieldSet({id:"conference.grantPanel",title:"权限设置",region:"center",layout:"form",border:true,items:[{anchor:"100%",fieldLabel:"修改人",xtype:"container",layout:"column",border:false,items:[{xtype:"hidden",name:"updater"},{columnWidth:1,anchor:"90%",xtype:"textfield",name:"updaters",readOnly:true,allowBlank:false,maxLength:256},{xtype:"button",text:"请选择",iconCls:"btn-user-sel",handler:function(){UserSelector.getView(function(a,c){var b=Ext.getCmp("conference.grantPanel");b.getCmpByName("updater").setValue(a);b.getCmpByName("updaters").setValue(c);}).show();}}]},{anchor:"100%",fieldLabel:"审核人",xtype:"container",layout:"column",border:false,items:[{xtype:"hidden",name:"conference.checkUserId"},{columnWidth:1,anchor:"90%",xtype:"textfield",name:"conference.checkName",readOnly:true,allowBlank:false,maxLength:64},{xtype:"button",text:"请选择",iconCls:"btn-user-sel",handler:function(){UserSelector.getView(function(a,c){var b=Ext.getCmp("conference.grantPanel");b.getCmpByName("conference.checkUserId").setValue(a);b.getCmpByName("conference.checkName").setValue(c);},true).show();}}]},{layout:"column",border:false,height:26}]});this.contextPanel=new Ext.form.FieldSet({title:"时间和内容设置",layout:"column",columnWidth:1,border:true,items:[{columnWidth:0.5,anchor:"100%",layout:"form",border:false,items:[{anchor:"99%",xtype:"datetimefield",format:"Y-m-d H:i:s",editable:false,name:"conference.startTime",fieldLabel:"开始时间",allowBlank:false}]},{columnWidth:0.5,anchor:"100%",layout:"form",border:false,items:[{anchor:"99%",xtype:"datetimefield",name:"conference.endTime",format:"Y-m-d H:i:s",editable:false,fieldLabel:"结束时间",allowBlank:false}]},{columnWidth:1,layout:"form",height:100,anchor:"100%",border:false,items:[{anchor:"100%",name:"conference.confContent",xtype:"htmleditor",height:100,fieldLabel:"会议内容",allowBlank:false,maxLength:4000}]}]});this.filePanel=new Ext.form.FieldSet({id:"conferenceForm.filePath",layout:"form",region:"center",title:"附件信息",items:[{fieldLabel:"附件信息",xtype:"container",columnWidth:1,layout:"column",border:false,items:[{xtype:"hidden",name:"filePath"},{columnWidth:1,anchor:"99%",xtype:"panel",id:"resumeFilePanel",height:50,border:true,autoScroll:true,html:""},{width:75,layout:"form",defaultType:"button",border:false,items:[{iconCls:"menu-attachment",text:"上传附件",handler:this.upLoadFile},{text:"清除附件",iconCls:"reset",handler:this.delLoadFile}]}]}]});this.formPanel=new Ext.FormPanel({id:"ConferenceFormPanel",autoScroll:false,layout:"form",region:"center",border:false,bodyStyle:"padding:10px 10px 10px 10px;",defaults:{readOnly:true},items:[this.basePanel,this.contextPanel,{layout:"column",border:false,columnWidth:1,defaults:{border:false},items:[{columnWidth:0.5,anchor:"100%",layout:"form",items:[this.jonerPanel]},{anchor:"100%",columnWidth:0.5,layout:"form",items:[this.grantPanel]}]},this.filePanel]});if(this.confId!=null&&this.confId!=""&&this.confId!="undenfied"){this.formPanel.loadData({url:__ctxPath+"/admin/getConference.do?confId="+this.confId,root:"data",preName:"conference",success:function(a,b){var c=Ext.util.JSON.decode(a.responseText);ConferenceForm.setGrantPanel(c);ConferenceForm.setFilePanel(c.data.attachFiles);},failure:function(){Ext.ux.Toast.msg("操作提示","数据加载失败！");}});}this.buttons=[{text:"暂存会议信息",iconCls:"temp",handler:this.save.createCallback(this.formPanel,this)},{text:"发送会议通知",iconCls:"btn-mail_send",handler:this.send.createCallback(this.formPanel,this)},{text:"取消",iconCls:"btn-cancel",handler:this.cancel.createCallback(this)}];},cancel:function(a){a.close();},save:function(a,c){if(a.getForm().isValid()){var b=Ext.getCmp("ConferenceFormPanel");var d=new Date().format("Y-m-d H:i:s");if(d>b.getCmpByName("conference.startTime").value){Ext.ux.Toast.msg("操作提示","对不起，开会时间必须大于当前时间，请重新输入！");b.getCmpByName("conference.startTime").focus(true);return;}if(b.getCmpByName("conference.startTime").value>=b.getCmpByName("conference.endTime").value){Ext.ux.Toast.msg("操作提示","对不起，开会时间有误，请重新输入！");b.getCmpByName("conference.startTime").focus(true);return;}if(!ConferenceForm.validateCompereAndRecorder()){return;}a.getForm().submit({url:__ctxPath+"/admin/tempConference.do",method:"post",waitMsg:"数据正在保存，请稍后...",success:function(e,f){Ext.ux.Toast.msg("操作提示","成功保存信息！");Ext.getCmp("ZanCunConferenceGrid").getStore().reload({params:{start:0,limit:25}});c.close();},failure:function(e,f){Ext.MessageBox.show({title:"操作信息",msg:Ext.util.JSON.decode(f.response.responseText),buttons:Ext.MessageBox.OK,icon:"ext-mb-error"});}});}},send:function(a,c){if(a.getForm().isValid()){var b=Ext.getCmp("ConferenceFormPanel");var d=new Date().format("Y-m-d H:i:s");if(d>b.getCmpByName("conference.startTime").value){Ext.ux.Toast.msg("操作提示","对不起，开会时间必须在大于当前时间，请重新输入！");b.getCmpByName("conference.startTime").focus(true);return;}if(b.getCmpByName("conference.startTime").value>=b.getCmpByName("conference.endTime").value){Ext.ux.Toast.msg("操作提示","对不起，开会时间有误，请重新输入！");b.getCmpByName("conference.startTime").focus(true);return;}var d=new Date().format("Y-m-d H:i:s");if(d>b.getCmpByName("conference.startTime").value){Ext.ux.Toast.msg("操作提示","对不起，开会时间必须在当前时间之前，请重新输入！");b.getCmpByName("conference.startTime").focus(true);return;}if(!ConferenceForm.validateCompereAndRecorder()){return;}a.getForm().submit({url:__ctxPath+"/admin/sendConference.do",method:"post",waitMsg:"数据正在发送，请稍后...",success:function(e,f){Ext.ux.Toast.msg("操作提示","会议信息数据发送成功，等待审批！");Ext.getCmp("ZanCunConferenceGrid").getStore().reload({params:{start:0,limit:25}});c.close();},failure:function(e,g){var f=Ext.util.JSON.decode(g.response.responseText);Ext.MessageBox.show({title:"操作信息",msg:f.msg,buttons:Ext.MessageBox.OK,icon:"ext-mb-error"});}});}},upLoadFile:function(){var a=App.createUploadDialog({file_cat:"admin/conference",callback:function(b){var f=Ext.getCmp("conferenceForm.filePath");var c="";c=f.getCmpByName("filePath").getValue()!=""?f.getCmpByName("filePath").getValue()+",":"";var e=Ext.getCmp("resumeFilePanel");for(var d=0;d<b.length;d++){c+=b[d].fileId+",";Ext.DomHelper.append(e.body,'<span><a href="#" onclick="FileAttachDetail.show('+b[d].fileId+')">'+b[d].fileName+'</a><img class="img-delete" src="'+__ctxPath+'/images/system/delete.gif" onclick="removeResumeFile(this,'+b[d].fileId+')"/>&nbsp;|&nbsp;</span>');}f.getCmpByName("filePath").setValue(c.substring(0,c.length-1));}});a.show("querybtn");},delLoadFile:function(){var b=Ext.getCmp("conferenceForm.filePath");var a=b.getCmpByName("filePath").value;if(a!=null&&a!=""&&a!="undefined"){Ext.Msg.confirm("确认信息","您真的要删除上传文件吗？",function(c){if(c=="yes"){Ext.Ajax.request({url:__ctxPath+"/system/multiDelFileAttach.do",method:"post",params:{ids:a},success:function(){Ext.ux.Toast.msg("操作提示","上传文件删除成功！");b.getCmpByName("filePath").setValue("");Ext.getCmp("resumeFilePanel").update();},failure:function(){Ext.ux.Toast.msg("操作提示","对不起，您上传文件删除失败！");}});}});}else{Ext.ux.Toast.msg("操作提示","对不起，你还没有上传文件！");}}});ConferenceForm.setFilePanel=function(b){var d="";var c="";var f=Ext.getCmp("resumeFilePanel");for(var e=0;e<b.length;e++){d+=b[e].fileId+",";var a='</a><img class="img-delete" src="'+__ctxPath+'/images/system/delete.gif" onclick="removeResumeFile(this,'+b[e].fileId+')"/>';c+='<span><a href="#" onclick="FileAttachDetail.show('+b[e].fileId+')">'+b[e].fileName+a+"&nbsp;|&nbsp;</span>";}Ext.DomHelper.append(f.body,c);Ext.getCmp("conferenceForm.filePath").getCmpByName("filePath").setValue(d.substring(0,d.length-1));};ConferenceForm.setGrantPanel=function(d){var e=d.data.confPrivilege;var f="";var c="";for(var a=0;a<e.length;a++){if(e[a].rights==2){f+=e[a].userId+",";c+=e[a].fullname+",";}}var b=Ext.getCmp("conference.grantPanel");b.getCmpByName("updater").setValue(f.substring(0,f.length-1));b.getCmpByName("updaters").setValue(c.substring(0,c.length-1));};ConferenceForm.validateCompereAndRecorder=function(){var d=Ext.getCmp("conference.jonerPanel");var b=d.getCmpByName("conference.compere").value.split(",");var a=d.getCmpByName("conference.recorder").value.split(",");var e=true;if(b.length==1&&a.length==1){if(b[0].search(a)>=0){e=false;}}else{if(b.length==1&&a.length!=1){for(var c=0;c<a.length;c++){if(a[c].search(b)>=0){e=false;}}}else{if(b.length!=1&&a.length==1){for(var c=0;c<b.length;c++){if(b[c].search(a)>=0){e=false;}}}}}if(e==false){d.getCmpByName("conference.compereName").focus(true);Ext.ux.Toast.msg("操作提示","对不起，会议主持人和记录人不能出现重复，请重新选择！");}return e;};function removeResumeFile(e,a){var b=Ext.getCmp("conferenceFormFilePath");var d=b.getValue();if(d.indexOf(",")<0){b.setValue("");}else{d=d.replace(","+a,"").replace(a+",","");b.setValue(d);}var c=Ext.get(e.parentNode);c.remove();}