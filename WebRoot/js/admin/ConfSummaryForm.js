ConfSummaryForm=Ext.extend(Ext.Window,{formPanel:null,constructor:function(a){Ext.applyIf(this,a);this.initUIComponents();ConfSummaryForm.superclass.constructor.call(this,{id:"ConfSummaryFormWin",iconCls:"menu-confSummary",layout:"fit",items:this.formPanel,modal:true,height:350,minHeight:350,width:420,minWidth:420,maximizable:true,title:"编辑会议纪要",buttonAlign:"center",buttons:this.buttons,keys:{key:Ext.EventObject.ENTER,fn:this.save.createCallback(this.formPanel,this,0),scope:this}});},initUIComponents:function(){this.formPanel=new Ext.FormPanel({layout:"form",bodyStyle:"padding:10px 10px 10px 10px",border:false,id:"ConfSummaryForm",defaults:{anchor:"98%,98%"},items:[{name:"confSummary.sumId",xtype:"hidden",value:this.sumId==null?"":this.sumId},{anchor:"99%",fieldLabel:"会议议题",name:"confSummary.confId.confTopic",xtype:"textfield",readOnly:true},{xtype:"hidden",name:"confSummary.confId.confId"},{anchor:"99%",fieldLabel:"纪要创建时间",name:"confSummary.createtime",xtype:"textfield",readOnly:true},{anchor:"99%",xtype:"container",layout:"column",fieldLabel:"纪要人",items:[{columnWidth:1,anchor:"100%",xtype:"textfield",name:"confSummary.creator",readOnly:true,allowBlank:false,maxLength:256},{xtype:"button",text:"请选择",iconCls:"btn-user-sel",handler:function(){UserSelector.getView(function(a,b){Ext.getCmp("ConfSummaryForm").getCmpByName("confSummary.creator").setValue(b);}).show();}}]},{anchor:"99%",xtype:"textarea",fieldLabel:"纪要内容",name:"confSummary.sumContent",allowBlank:false,maxLength:4000},{anchor:"99%",fieldLabel:"状态",hiddenName:"confSummary.status",xtype:"combo",mode:"local",readOnly:true,editable:false,triggerAction:"all",store:[["0","未发送"],["1","发送"]]},{anchor:"99%",fieldLabel:"附件",xtype:"container",layout:"column",border:false,defaults:{border:false},items:[{columnWidth:1,layout:"form",border:false,items:[{anchor:"100%",xtype:"panel",id:"confSummaryFormFilePanel",frame:false,border:true,bodyStyle:"padding:4px 4px 4px 4px",height:50,autoScroll:true,html:""},{xtype:"hidden",name:"fileIds"}]},{items:[{xtype:"button",text:"添加附件",iconCls:"menu-attachment",handler:this.upLoadFile},{xtype:"button",text:"清除附件",iconCls:"reset",handler:this.delLoadFile}]}]}]});if(this.sumId!=null&&this.sumId!="undefined"){this.formPanel.loadData({url:__ctxPath+"/admin/getConfSummary.do?sumId="+this.sumId,root:"data",preName:"confSummary",success:function(a,c){var b=Ext.util.JSON.decode(a.responseText);ConfSummaryForm.setFilePanel(b.data.attachFiles);},failure:function(a,b){Ext.ux.Toast.msg("操作提示","对不起，数据加载有误！");}});}this.buttons=[{text:"发送",iconCls:"btn-mail_send",handler:this.save.createCallback(this.formPanel,this,1)},{text:"保存",iconCls:"btn-save",handler:this.save.createCallback(this.formPanel,this,0)},{text:"取消",iconCls:"btn-cancel",handler:this.cancel.createCallback(this)}];},cancel:function(a){a.close();},save:function(a,d,c){var b=c==0?__ctxPath+"/admin/editConfSummary.do":__ctxPath+"/admin/sendConfSummary.do";if(a.getForm().isValid()){a.getForm().submit({url:b,method:"post",waitMsg:"正在提交数据，请稍后...",success:function(e,g){Ext.ux.Toast.msg("操作信息",c==0?"会议纪要保存成功！":"会议纪要发送成功！");var f=Ext.getCmp("ConfSummaryGrid");if(f!=null){f.getStore().reload();}d.close();},failure:function(e,f){Ext.MessageBox.show({title:"操作信息",msg:"信息发送出错，请联系管理员！",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});d.close();}});}},upLoadFile:function(){var a=App.createUploadDialog({url:__ctxPath+"/file-upload",file_cat:"admin/confSummary",callback:function(b){var g="";var d="";for(var c=0;c<b.length;c++){g+=b[c].fileId+",";d+='<span><a href="#" onclick="FileAttachDetail.show('+b[c].fileId+')">'+b[c].fileName+'</a> <img class="img-delete" src="'+__ctxPath+'/images/system/delete.gif" onclick="removeContractAttach(this,'+b[c].fileId+')"/>&nbsp;|&nbsp;</span>';}g=g.substring(0,g.length-1);var e=Ext.getCmp("ConfSummaryForm");e.getCmpByName("fileIds").setValue(g);var f=Ext.getCmp("confSummaryFormFilePanel");Ext.DomHelper.append(f.body,d);}});a.show("querybtn");},delLoadFile:function(){var b=Ext.getCmp("ConfSummaryForm");var a=b.getCmpByName("fileIds").value;if(a!=null&&a!=""&&a!="undefined"){Ext.Msg.confirm("确认信息","您真的要删除上传文件吗？",function(c){if(c=="yes"){Ext.Ajax.request({url:__ctxPath+"/system/multiDelFileAttach.do",method:"post",params:{ids:a},success:function(){Ext.ux.Toast.msg("操作提示","上传文件删除成功！");b.getCmpByName("fileIds").setValue("");Ext.getCmp("confSummaryFormFilePanel").update();},failure:function(){Ext.ux.Toast.msg("操作提示","对不起，您上传文件删除失败！");}});}});}else{Ext.ux.Toast.msg("操作提示","对不起，你还没有上传文件！");}}});function removeResumeFile(e,a){var b=Ext.getCmp("ConfSummaryForm").getCmpByName("fileIds");var d=b.getValue();if(d.indexOf(",")<0){b.setValue("");}else{d=d.replace(","+a,"").replace(a+",","");b.setValue(d);}alert(b);var c=Ext.get(e.parentNode);c.remove();}ConfSummaryForm.setFilePanel=function(b){var c="";var e=Ext.getCmp("confSummaryFormFilePanel");for(var d=0;d<b.length;d++){c+=b[d].fileId+",";var a='<img class="img-delete" src="'+__ctxPath+'/images/system/delete.gif" onclick="removeResumeFile(this,'+b[d].fileId+')"/>';Ext.DomHelper.append(e.body,'<span><a href="#" onclick="FileAttachDetail.show('+b[d].fileId+')">'+b[d].fileName+"</a>"+a+"&nbsp;|&nbsp;</span>");}Ext.getCmp("ConfSummaryForm").getCmpByName("fileIds").setValue(c.substring(0,c.length-1));};