RelativeUserView=Ext.extend(Ext.Window,{constructor:function(a){Ext.applyIf(this,a);this.initUIComponents();RelativeUserView.superclass.constructor.call(this,{id:"RelativeUserView",title:"该用户["+this.username+"]添加上下级管理",iconCls:"menu-relativeJob",region:"center",layout:"border",width:850,height:600,modal:true,maximizable:true,items:[this.treePanel,this.gridPanel]});},initUIComponents:function(){this.topbar=new Ext.Toolbar({defaultType:"button",items:[{iconCls:"btn-superior",text:"添加上级",scope:this,handler:this.addRelativeUser.createCallback(1,this.userId)},"-",{iconCls:"btn-sibling",text:"添加同级",scope:this,handler:this.addRelativeUser.createCallback(2,this.userId)},"-",{iconCls:"btn-subordinate",text:"添加下级",scope:this,handler:this.addRelativeUser.createCallback(0,this.userId)},"-",{iconCls:"btn-del",text:"删除",scope:this,handler:this.removeSelRs}]});this.treePanel=new Ext.tree.TreePanel({id:"RelativeUserViewTreePanel",region:"west",collapsible:true,autoScroll:true,split:true,width:150,title:"相对岗位列表",tbar:new Ext.Toolbar({items:[{xtype:"button",iconCls:"btn-refresh",text:"刷新",handler:function(){Ext.getCmp("RelativeUserViewTreePanel").root.reload();}},{xtype:"button",text:"展开",iconCls:"btn-expand",handler:function(){Ext.getCmp("RelativeUserViewTreePanel").expandAll();}},{xtype:"button",text:"收起",iconCls:"btn-collapse",handler:function(){Ext.getCmp("RelativeUserViewTreePanel").collapseAll();}}]}),loader:new Ext.tree.TreeLoader({url:__ctxPath+"/system/treeLoadRelativeJob.do"}),root:new Ext.tree.AsyncTreeNode({expanded:true}),rootVisible:false,listeners:{"click":function(f){if(f!=null){var e=Ext.getCmp("RelativeUserView").gridPanel.getStore();e.baseParams={reJobId:f.id};e.reload({params:{start:0,limit:25}});}}}});this.treePanel.on("contextmenu",c,this.treePanel);this.treeMenu=new Ext.menu.Menu({id:"RelativeUserMenu",items:[{iconCls:"btn-add",text:"新增岗位",scope:this,handler:b},{text:"修改岗位信息",iconCls:"btn-edit",scope:this,handler:a},{text:"删除岗位信息",iconCls:"btn-del",scope:this,handler:d}]});function c(f,g){selected=new Ext.tree.TreeNode({id:f.id,text:f.text});Ext.getCmp("RelativeUserMenu").showAt(g.getXY());}function b(){var f=selected.id;var e=Ext.getCmp("RelativeJobForm");if(e==null){if(f>0){new RelativeJobForm({nodeId:f}).show();}else{new RelativeJobForm({nodeId:0}).show();}}}function a(){var f=selected.id;if(f>0){var e=Ext.getCmp("RelativeJobForm");if(e==null){new RelativeJobForm().show();e=Ext.getCmp("RelativeJobForm");}e.form.load({url:__ctxPath+"/system/getRelativeJob.do",params:{reJobId:f},method:"post",deferredRender:true,layoutOnTabChange:true,failure:function(){Ext.ux.Toast.msg("操作提示","载入岗位信息失败!");}});}else{Ext.ux.Toast.msg("操作提示","对不起，公司名称不能修改，请原谅！");}}function d(){var e=selected.id;if(e>0){Ext.Msg.confirm("操作提示","你真的要删除该岗位信息吗？",function(f){if(f=="yes"){Ext.Ajax.request({url:__ctxPath+"/system/deleteRelativeJob.do?reJobId="+e,method:"post",success:function(g,i){var h=Ext.util.JSON.decode(g.responseText);if(h.success){Ext.ux.Toast.msg("操作提示","删除该岗位信息成功！");Ext.getCmp("RelativeUserViewTreePanel").root.reload();}else{Ext.ux.Toast.msg("操作提示","对不起，删除该岗位信息失败！");}},failure:function(){}});}});}else{Ext.ux.Toast.msg("操作提示","对不起，公司名称不能删除，请原谅！");}}this.gridPanel=new HT.GridPanel({region:"center",tbar:this.topbar,rowActions:true,id:"RelativeUserGrid",url:__ctxPath+"/system/listRelativeUser.do?userId="+this.userId,fields:[{name:"relativeUserId",type:"int"},"appUser","jobUser","isSuper","relativeJob"],columns:[{header:"relativeUserId",dataIndex:"relativeUserId",hidden:true},{header:"岗位员工",dataIndex:"jobUser",renderer:function(e){return e.username;}},{header:"上下级标识 ",dataIndex:"isSuper",renderer:function(e){if(e==0){return'<button class="btn-subordinate" title="下级"/>';}else{if(e==1){return'<button class="btn-superior" title="上级" />';}else{if(e==2){return'<button class="btn-sibling" title="同级" />';}else{return"";}}}}},new Ext.ux.grid.RowActions({header:"管理",width:100,actions:[{iconCls:"btn-del",qtip:"删除",style:"margin:0 3px 0 3px"}],listeners:{scope:this,"action":this.onRowAction}})]});},createRs:function(){new RelativeUserForm().show();},removeRs:function(a){$postDel({url:__ctxPath+"/system/multiDelRelativeUser.do",ids:a,grid:this.gridPanel});},removeSelRs:function(){$delGridRs({url:__ctxPath+"/system/multiDelRelativeUser.do",grid:this.gridPanel,idName:"relativeUserId"});},onRowAction:function(c,a,d,e,b){switch(d){case"btn-del":this.removeRs.call(this,a.data.relativeUserId);break;default:break;}},addRelativeUser:function(f,e){var b="";if(f==1){b="上级";}else{if(f==2){b="同级";}else{b="下级";}}var h=Ext.getCmp("RelativeUserViewTreePanel").getSelectionModel().getSelectedNode();if(h!=null&&h.id>0){var g=Ext.getCmp("RelativeUserView").gridPanel.getStore();var a=new Array();for(var d=0;d<g.getCount();d++){var c=g.getAt(d).data.jobUser;a.push({userId:c.userId,fullname:c.fullname});}UserSelector.getView(function(j,i){if(j!=""){Ext.Ajax.request({url:__ctxPath+"/system/mutliAddRelativeUser.do",method:"post",params:{"userId":e,"reJobId":h.id,"jobUserIds":j,"relativeUser.isSuper":f},success:function(k,m){var l=Ext.util.JSON.decode(k.responseText);Ext.ux.Toast.msg("操作提示",l.msg);g.reload();},failure:function(){Ext.ux.Toast.msg("操作提示","对不起，添加"+b+"用户信息失败！");}});}},false,false,a).show();}else{Ext.ux.Toast.msg("操作提示","请选择岗位名称！");}}});