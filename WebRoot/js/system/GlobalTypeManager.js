GlobalTypeManager=Ext.extend(Ext.Panel,{constructor:function(a){Ext.applyIf(this,a);this.initUIComponents();GlobalTypeManager.superclass.constructor.call(this,{id:"GlobalTypeManager",height:450,autoScroll:true,layout:"border",title:"系统分类树管理",items:[this.leftPanel,this.centerPanel]});},initUIComponents:function(){this.leftPanel=new Ext.Panel({region:"west",title:"分类管理",layout:"anchor",collapsible:true,split:true,width:200,tbar:new Ext.Toolbar({items:[{xtype:"button",text:"新建类",iconCls:"btn-add",handler:function(){new TypeKeyForm().show();}}]}),items:[{xtype:"panel",layout:"fit",items:[{xtype:"combo",editable:false,id:"comboGlobalType",hiddenName:"comboGlobalTypeValue",displayField:"name",valueField:"key",mode:"local",triggerAction:"all",store:new Ext.data.SimpleStore({autoLoad:true,url:__ctxPath+"/system/comboTypeKey.do",fields:["key","name"],listeners:{scope:this,"load":function(e){if(e.getCount()>0){var d=e.getAt(0);var g=d.data.key;Ext.getCmp("comboGlobalType").setValue(g);var h=Ext.getCmp("GlobalTypeTree");h.loader=new Ext.tree.TreeLoader({baseParams:{catKey:g},dataUrl:__ctxPath+"/system/treeGlobalType.do",requestMethod:"GET"});h.selectedNode=null;h.root.reload();var f=Ext.getCmp("globalTypeCenGrid");if(f!=null){var e=f.getStore();e.url=__ctxPath+"/system/subGlobalType.do";e.baseParams={parentId:0,catKey:g};e.reload();}}}}}),listeners:{scope:this,"select":function(j,d,f){var h=j.getValue();var i=Ext.getCmp("GlobalTypeTree");i.loader=new Ext.tree.TreeLoader({baseParams:{catKey:h},dataUrl:__ctxPath+"/system/treeGlobalType.do",requestMethod:"GET"});i.selectedNode=null;i.root.reload();var g=Ext.getCmp("globalTypeCenGrid");if(g!=null){var e=g.getStore();e.url=__ctxPath+"/system/subGlobalType.do";e.baseParams={parentId:0,catKey:h};e.reload();}}}}]},{xtype:"treePanelEditor",id:"GlobalTypeTree",title:"分类树",split:true,border:false,height:380,autoScroll:true,url:__ctxPath+"/system/treeGlobalType.do?catKey=DP",onclick:function(g){var h=g.id;var e=Ext.getCmp("globalTypeCenGrid");if(e!=null){var f=Ext.getCmp("comboGlobalType").getValue();var d=e.getStore();d.url=__ctxPath+"/system/subGlobalType.do";d.baseParams={parentId:h,catKey:f};d.reload();}},contextMenuItems:[{text:"新建分类",scope:this,iconCls:"btn-add",handler:function(){var d=Ext.getCmp("GlobalTypeTree");var g=d.selectedNode.id;var e=Ext.getCmp("comboGlobalType").getValue();var f=new GlobalTypeForm({parentId:g,catKey:e,callback:function(){Ext.getCmp("GlobalTypeTree").root.reload();Ext.getCmp("globalTypeCenGrid").getStore().reload();}});f.show();}},{text:"修改分类",scope:this,iconCls:"btn-edit",handler:function(){var e=Ext.getCmp("GlobalTypeTree");var d=e.selectedNode.id;var f=new GlobalTypeForm({proTypeId:d,callback:function(){Ext.getCmp("GlobalTypeTree").root.reload();Ext.getCmp("globalTypeCenGrid").getStore().reload();}});f.show();}}]}]});this.store=new Ext.data.JsonStore({url:__ctxPath+"/system/subGlobalType.do",baseParams:{parentId:0},root:"result",remoteSort:true,fields:[{name:"proTypeId",type:"int"},"typeName","nodeKey","sn"]});this.store.load();this.rowActions=new Ext.ux.grid.RowActions({header:"管理",width:80,actions:[{iconCls:"btn-last",qtip:"向下",style:"margin:0 3px 0 3px"},{iconCls:"btn-up",qtip:"向上",style:"margin:0 3px 0 3px"}]});this.rowActions.on("action",this.onRowAction,this);var c=new Ext.grid.CheckboxSelectionModel();var a=new Ext.grid.ColumnModel({columns:[c,new Ext.grid.RowNumberer(),{header:"proTypeId",dataIndex:"proTypeId",hidden:true},{header:"名称",dataIndex:"typeName",editor:new Ext.form.TextField({allowBlank:false})},{header:"节点Key",dataIndex:"nodeKey",editor:new Ext.form.TextField({allowBlank:false})},{header:"序号",dataIndex:"sn"},this.rowActions],defaults:{sortable:true,menuDisabled:false,width:100}});var b=new Ext.Toolbar({items:[{text:"新建分类",iconCls:"btn-add",handler:function(){var d=Ext.getCmp("GlobalTypeTree");var f=d.selectedNode;if(!f){Ext.ux.Toast.msg("操作信息","请选择左树中的分类！");return;}var e=Ext.getCmp("comboGlobalType").getValue();var g=new GlobalTypeForm({parentId:f.id,catKey:e,callback:function(){Ext.getCmp("GlobalTypeTree").root.reload();Ext.getCmp("globalTypeCenGrid").getStore().reload();}});g.show();}},"-",{xtype:"button",text:"保存",iconCls:"btn-save",scope:this,handler:function(){var g=this.centerPanel;var e=g.getStore();var h=[];for(var f=0;f<e.getCount();f+=1){var d=e.getAt(f);h.push(d.data);}Ext.Ajax.request({method:"post",url:__ctxPath+"/system/mulSaveGlobalType.do",params:{data:Ext.encode(h)},success:function(i){Ext.ux.Toast.msg("操作信息","成功设置");e.reload();g.getView().refresh();Ext.getCmp("GlobalTypeTree").root.reload();},failure:function(i){Ext.ux.Toast.msg("操作信息","设置出错，请联系管理员!");}});}},{text:"删除",iconCls:"btn-del",scope:this,handler:function(){var f=this.centerPanel;var d=f.getSelectionModel().getSelections();if(d.length==0){Ext.ux.Toast.msg("信息","请选择要删除的记录！");return;}var g=Array();for(var e=0;e<d.length;e++){g.push(d[e].data.proTypeId);}Ext.Msg.confirm("信息确认","您确认要删除所选记录吗？",function(h){if(h=="yes"){Ext.Ajax.request({url:__ctxPath+"/system/multiDelGlobalType.do",params:{ids:g},method:"POST",success:function(i,j){Ext.ux.Toast.msg("操作信息","成功删除该产品分类！");f.getStore().reload();Ext.getCmp("GlobalTypeTree").root.reload();},failure:function(i,j){Ext.ux.Toast.msg("操作信息","操作出错，请联系管理员！");}});}});}}]});this.centerPanel=new Ext.grid.EditorGridPanel({region:"center",title:"分类列表",tbar:b,clicksToEdit:1,id:"globalTypeCenGrid",store:this.store,plugins:this.rowActions,sm:c,cm:a,height:450});},onRowAction:function(e,d,c,i,b){var a=Ext.getCmp("globalTypeCenGrid");var g=a.getStore();switch(c){case"btn-up":if(i==0){Ext.ux.Toast.msg("操作信息","已经为第一条!");return;}var h=g.getAt(i-1);var f=g.getAt(i);g.removeAt(i);g.removeAt(i-1);g.insert(i-1,f);g.insert(i,h);break;case"btn-last":if(i==g.getCount()-1){Ext.ux.Toast.msg("操作信息","已经为最后一条!");return;}var h=g.getAt(i);var f=g.getAt(i+1);g.removeAt(i+1);g.removeAt(i);g.insert(i,f);g.insert(i+1,h);break;default:break;}}});