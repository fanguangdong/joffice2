Ext.ns("MyFileAttachView");MyFileAttachView=Ext.extend(Ext.Panel,{treePanel:null,searchPanel:null,gridPanel:null,constructor:function(a){Ext.applyIf(this,a);this.initUIComponent();MyFileAttachView.superclass.constructor.call(this,{id:"1MyFileAttachView",title:"我的附件",iconCls:"menu-attachment",layout:"border",region:"center",autoScroll:true,items:[this.searchPanel,this.treePanel,this.gridPanel]});},initUIComponent:function(){this.treePanel=new Ext.tree.TreePanel({layout:"form",region:"west",id:"myFileAttachViewTreePanel",title:"附件分类",collapsible:true,autoScroll:true,split:true,width:180,tbar:new Ext.Toolbar({items:[{xtype:"button",iconCls:"btn-refresh",text:"刷新",handler:function(){Ext.getCmp("myFileAttachViewTreePanel").root.reload();}},"-",{xtype:"button",text:"展开",iconCls:"btn-expand",handler:function(){Ext.getCmp("myFileAttachViewTreePanel").expandAll();}},"-",{xtype:"button",text:"收起",iconCls:"btn-collapse",handler:function(){Ext.getCmp("myFileAttachViewTreePanel").collapseAll();}}]}),loader:new Ext.tree.TreeLoader({url:__ctxPath+"/system/treeLoadFileAttach.do"}),root:new Ext.tree.AsyncTreeNode({expanded:true}),rootVisible:false,listeners:{"click":this.nodeClick}});var d=new Ext.Toolbar({id:"myFileAttachViewToolbar",height:30,bodyStyle:"text-align:left",defaultType:"button",items:[{text:"删除",iconCls:"btn-del",handler:this.removeAll,scope:this}]});this.searchPanel=new Ext.FormPanel({region:"north",height:35,frame:false,border:false,id:"MyFileAttachSearchForm",layout:"hbox",keys:{key:Ext.EventObject.ENTER,fn:this.search,scope:this},layoutConfig:{padding:"5",align:"middle"},defaults:{xtype:"label",margins:{top:0,right:4,bottom:4,left:4}},items:[{text:"请输入查询条件:"},{text:"文件名"},{xtype:"textfield",width:80,name:"Q_fileName_S_LK"},{text:"创建时间"},{xtype:"datefield",format:"Y-m-d H:i:s",width:80,name:"Q_createtime_D_GE"},{text:"扩展名"},{xtype:"textfield",width:60,name:"Q_ext_S_LK"},{text:"上传者"},{xtype:"textfield",width:80,name:"Q_creator_S_LK"},{xtype:"button",text:"查询",iconCls:"search",handler:this.search},{xtype:"button",text:"清空",iconCls:"reset",handler:this.reset}]});var c=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:__ctxPath+"/system/listAllFileAttach.do"}),baseParams:{"Q_delFlag_N_EQ":0,"Q_creatorId_L_EQ":curUserInfo.userId},reader:new Ext.data.JsonReader({root:"result",totalProperty:"totalCounts",id:"id",fields:[{name:"fileId",type:"int"},"fileName","filePath","createtime","ext","type","note","creator","fileType"]}),remoteSort:true});c.setDefaultSort("fileId","desc");var b=new Ext.ux.grid.RowActions({header:"管理",width:80,actions:[{iconCls:"btn-del",qtip:"删除",style:"margin:0 3px 0 3px"},{iconCls:"btn-detail",qtip:"查看",style:"margin:0 3px 0 3px"}]});var e=new Ext.grid.CheckboxSelectionModel();var a=new Ext.grid.ColumnModel({columns:[e,new Ext.grid.RowNumberer(),{header:"fileId",dataIndex:"fileId",hidden:true},{header:"文件名",dataIndex:"fileName"},{header:"文件路径",dataIndex:"filePath"},{header:"创建时间",dataIndex:"createtime"},{header:"扩展名",dataIndex:"ext"},{header:"附件类型",dataIndex:"fileType"},{header:"说明",dataIndex:"note"},{header:"上传者",dataIndex:"creator"},b],defaults:{sortable:true,menuDisabled:true,width:100}});c.load({params:{start:0,limit:25}});this.gridPanel=new Ext.grid.GridPanel({id:"MyFileAttachGrid",layout:"border",region:"center",tbar:d,store:c,trackMouseOver:true,disableSelection:false,loadMask:true,cm:a,sm:e,plugins:b,viewConfig:{forceFit:true,enableRowBody:false,showPreview:false},bbar:new HT.PagingBar({store:c})});this.gridPanel.addListener("rowdblclick",function(g,f,h){g.getSelectionModel().each(function(i){if(isGranted("_FileAttachEdit")){FileAttachDetail.show(i.data.fileId);}});});b.on("action",this.onRowAction,this);},detail:function(a){if(a!=null&&a!=""&&a!="undefined"){FileAttachDetail.show(a);}},search:function(){var a=Ext.getCmp("MyFileAttachSearchForm");var b=Ext.getCmp("MyFileAttachGrid");if(a.getForm().isValid()){$search({searchPanel:a,gridPanel:b});}},reset:function(){var a=Ext.getCmp("MyFileAttachSearchForm");a.getForm().reset();},removeAll:function(){var c=Ext.getCmp("MyFileAttachGrid");var a=c.getSelectionModel().getSelections();if(a.length==0){Ext.ux.Toast.msg("操作提示","请选择要删除的记录！");return;}var d=Array();for(var b=0;b<a.length;b++){d.push(a[b].data.fileId);}this.remove(d);},remove:function(b){var a=Ext.getCmp("MyFileAttachGrid");Ext.Msg.confirm("信息确认","您确认要删除该记录吗？",function(c){if(c=="yes"){Ext.Ajax.request({url:__ctxPath+"/system/multiDelFileAttach.do",params:{ids:b},method:"post",success:function(){Ext.ux.Toast.msg("信息提示","成功删除所选记录！");a.getStore().reload({params:{start:0,limit:25}});}});}});},nodeClick:function(b){if(b!=null){var c="";if(b.getDepth()>1){b.bubble(function(d){c=d.id+"/"+c;});c=c.substring(12,c.length-1);}var a=Ext.getCmp("MyFileAttachGrid").getStore();a.url=__ctxPath+"/system/listFileAttach.do";a.reload({params:{start:0,limit:25,"Q_fileType_S_LK":c,"Q_delFlag_N_EQ":0}});}},onRowAction:function(c,a,d,e,b){switch(d){case"btn-detail":this.detail(a.data.fileId);break;case"btn-del":this.remove(a.data.fileId);break;default:break;}}});