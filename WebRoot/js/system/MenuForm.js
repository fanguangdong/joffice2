MenuForm=Ext.extend(Ext.Window,{constructor:function(a){Ext.applyIf(this,a);this.initUIComponent(this.id,this.text,this.isChild);MenuForm.superclass.constructor.call(this,{id:"menuFormWin",title:this.text!=null?"新增/编辑菜单["+this.text+"]信息":"新增编辑菜单信息",iconCls:"menu-m",layout:"fit",modal:true,plain:false,maximizable:true,width:650,height:500,style:"padding: 5px 5px 5px 5px;",buttonAlign:"center",keys:{key:Ext.EventObject.ENTER,fn:this.submit,scope:this},buttons:[{text:"确定",iconCls:"btn-ok",handler:this.submit},{text:"取消",iconCls:"btn-cancel",handler:function(){Ext.getCmp("menuFormWin").close();}}],items:[this.formPanel]});},initUIComponent:function(g,e,b){var d=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:__ctxPath+"/menu/getMenu.do"}),reader:new Ext.data.JsonReader({root:"fn",totalProperty:"totalCounts",id:"id",fields:["fId","fText","fIconCls"]}),remoteSort:false});if(g!=null&&g!="undefined"){d.load({params:{id:g}});}var f=new Ext.grid.CheckboxSelectionModel();var a=new Ext.grid.ColumnModel({columns:[f,new Ext.grid.RowNumberer(),{header:"fId",dataIndex:"fId",hidden:true,sortable:true,menuDisabled:true},{header:"权限名称",dataIndex:"fText",sortable:true,menuDisabled:true},{header:"图标",dataIndex:"fIconCls",renderer:function(h){return h!=null?'<button style="width:13px;height:13px;" class="'+h+'"/>':"";},sortable:true,menuDisabled:true}]});var c=new Ext.grid.GridPanel({id:"MenuFormEditGrid",title:"菜单权限列表",autoHeight:true,autoScroll:true,sm:f,trackMouseOver:true,tbar:new Ext.Toolbar({height:30,items:[{text:"添加",iconCls:"btn-add",scope:this,handler:this.addFn.createCallback(g,e,b)},"-",{text:"删除",iconCls:"btn-del",scope:this,handler:this.del.createCallback(g)}]}),store:d,cm:a,viewConfig:{forceFit:true,enableRowBody:false,showPreview:false}});c.addListener("rowdblclick",function(h,j,i){h.getSelectionModel().each(function(k){new MenuFunctionForm({fId:k.data.fId,fText:k.data.fText,menuId:g,menuText:e}).show();});});this.formPanel=new Ext.FormPanel({id:"MenuFormPanel",layout:"form",region:"center",border:false,anchor:"98% 98%",url:__ctxPath+"/system/saveMenu.do",defaultType:"textfield",style:"padding: 5px 5px 5px 5px;margins: 5px 5px 5px 5px;",autoScroll:true,items:[{xtype:"fieldset",title:"基本信息",layout:"form",defaultType:"textfield",items:[{xtype:"hidden",name:"parentId",value:this.parentId!=null?this.parentId:""},{name:"id",width:"93%",fieldLabel:"编号",maxLength:125,allowBlank:false,readOnly:this.id!=null?true:false},{xtype:"hidden",name:"type",value:this.text!=null?"edit":"add"},{name:"text",width:"93%",fieldLabel:"显示文本",maxLength:125,allowBlank:false},{xtype:"container",height:30,layout:"column",defaultType:"textfield",items:[{xtype:"label",text:"图标:",width:105},{columnWidth:0.93,name:"iconCls",fieldLabel:"图标"},{width:100,xtype:"button",iconCls:"menu-m",text:"请选择",handler:function(){IconSelector.getView(function(i){var h=Ext.getCmp("MenuFormPanel");h.getCmpByName("iconCls").setValue(i);}).show();}}]}]},{xtype:"fieldset",title:"权限设置",layout:"form",autoScroll:true,items:[c]}]});if(this.id!=null&&this.id!="undefined"){this.formPanel.getForm().load({deferredRender:true,url:__ctxPath+"/menu/getMenu.do",params:{id:g},waitMsg:"数据正在加载，请稍后...",success:function(h,i){}});}},submit:function(){var a=Ext.getCmp("MenuFormPanel");var b=a.getCmpByName("type").getValue()=="add"?"/menu/addMenu.do":"/menu/editMenu.do";if(a.getForm().isValid()){a.getForm().submit({deferredRender:false,url:__ctxPath+b,waitMsg:"数据正在提交，请稍后...",success:function(){Ext.ux.Toast.msg("操作提示","数据操作成功！");Ext.getCmp("menuViewTreePanel").root.reload();if(curUserInfo.username=="admin"){loadWestMenu("true");}else{Ext.ux.Toast.msg("操作提示","仅对开发用户开放刷新菜单功能!");}Ext.getCmp("menuFormWin").close();},failure:function(c,e){var d=Ext.util.JSON.decode(e.response.responseText);Ext.ux.Toast.msg("操作提示",d.msg);}});}},del:function(e){var c=Ext.getCmp("MenuFormEditGrid");var d=c.getSelectionModel().getSelections();if(d!=null&&d.length>0){var a="";for(var b=0;b<d.length;b++){a+=d[b].data.fId;if(b!=d.length-1){a+=",";}}Ext.Msg.confirm("操作提示","你真的要删除吗？",function(f){if(f=="yes"){Ext.Ajax.request({url:__ctxPath+"/menu/delFnMenu.do",params:{id:e,fId:a},method:"post",waitMsg:"数据正在提交，请稍后...",success:function(){c.getStore().reload();},failure:function(){Ext.ux.Toast.msg("操作提示","删除权限信息失败！");}});}});}else{Ext.ux.Toast.msg("操作提示","请选择要删除的数据！");}},addFn:function(c,b,a){if(a){new MenuFunctionForm({menuId:c,menuText:b}).show();}else{Ext.ux.Toast.msg("操作提示","对不起，该菜单存在子项，不能添加权限！");}}});