Ext.ns("ProDefinitionView");var ProDefinitionView=function(a){this.isManager=a;};ProDefinitionView.prototype.setTypeId=function(a){this.typeId=a;ProDefinitionView.typeId=a;};ProDefinitionView.prototype.getView=function(){var b=this.typeId;var a=new Ext.FormPanel({height:40,frame:false,border:false,region:"north",layout:"hbox",layoutConfig:{padding:"5",align:"middle"},defaults:{margins:"4 4 4 4"},items:[{xtype:"label",text:"请输入查询条件:"},{text:"流程的名称",xtype:"label"},{xtype:"textfield",name:"proDefinition.name",width:160},{xtype:"button",text:"查询",iconCls:"search",scope:this,handler:function(){if(a.getForm().isValid()){$search({searchPanel:a,gridPanel:this.gridPanel});}}}]});this.gridPanel=this.setup();return new Ext.Panel({title:"流程列表",layout:"border",region:"center",autoScroll:true,items:[a,this.gridPanel]});};ProDefinitionView.prototype.setup=function(){var d=this.isManager;var e=0;var g=new Ext.grid.CheckboxSelectionModel();var a=new Ext.grid.ColumnModel({columns:[g,new Ext.grid.RowNumberer(),{header:"defId",dataIndex:"defId",hidden:true},{header:"分类名称",dataIndex:"proType",renderer:function(h){if(h!=null){return h.typeName;}else{return"<font color='red'>未定义</font>";}}},{header:"流程的名称",dataIndex:"name"},{header:"描述",dataIndex:"description"},{header:"创建时间",dataIndex:"createtime"},{header:"工作流id",dataIndex:"deployId",hidden:"true"},{header:"状态",dataIndex:"status",renderer:function(h){if(h!=null&&h==1){return'<font color="green">激活</font>';}else{return'<font color="red">禁用</font>';}},editor:d?new Ext.form.ComboBox({allowBlank:false,editable:false,mode:"local",triggerAction:"all",store:[["0","禁用"],["1","激活"]],listeners:{"change":function(l,k,i){var j=Ext.getCmp("ProDefinitionGrid"+(d?"":"0"));var h=j.getStore().getAt(e);Ext.Ajax.request({url:__ctxPath+"/flow/updateProDefinition.do",params:{"proDefinition.defId":h.get("defId"),"proDefinition.status":k},method:"POST",success:function(m,n){Ext.ux.Toast.msg("操作信息","修改成功！");},failure:function(m,n){Ext.ux.Toast.msg("操作信息","操作出错，请联系管理员！");}});}}}):null},{header:"管理",dataIndex:"defId",renderer:function(p,o,l,n,q){var i=l.data.defId;var h=l.data.name;var k=l.data.deployId;var j=l.data.drawDefXml;var m="";if(d){if(isGranted("_FlowDel")){m='<button title="删除" value=" " class="btn-del" onclick="ProDefinitionView.remove('+i+')"></button>';}if(isGranted("_FlowEdit")&&j!=null){m+='&nbsp;<button title="编辑在线" value=" " class="btn-flow-design" onclick=" ProDefinitionView.reDesign('+i+')"></button>';}if(isGranted("_FlowEdit")){m+='&nbsp;<button title="编辑" value=" " class="btn-edit" onclick="ProDefinitionView.edit('+i+",'"+h+"')\"></button>";}}if(k!=null){m+='&nbsp;<button title="查看" class="btn-preview" onclick="ProDefinitionView.view('+i+",'"+h+"')\"></button>";if(d){if(isGranted("_FlowSetting")){m+='&nbsp;<button title="流程设置" class="btn-setting" onclick="ProDefinitionView.setting('+""+i+",'"+h+"')\"></button>";}}m+='&nbsp;<button title="新建流程" class="btn-newFlow" onclick="ProDefinitionView.newFlow('+""+i+",'"+h+"')\"></button>";}if(d){m+='&nbsp;<button title="设置权限" class="btn-shared" onclick="ProDefinitionView.rights('+i+')"></button>';}return m;}}],defaults:{sortable:true,menuDisabled:false}});var f=d?this.topbar():null;var b=this.store();b.load({params:{start:0,limit:25}});var c=new Ext.grid.EditorGridPanel({clicksToEdit:1,region:"center",id:"ProDefinitionGrid"+(d?"":"0"),tbar:f,store:b,trackMouseOver:true,disableSelection:false,loadMask:true,cm:a,sm:g,viewConfig:{forceFit:true,enableRowBody:false,showPreview:false},bbar:new HT.PagingBar({store:b})});c.addListener("rowdblclick",function(i,h,j){e=h;i.getSelectionModel().each(function(k){if(d){if(isGranted("_FlowEdit")){ProDefinitionView.reDesign(k.data.defId);}}});});return c;};ProDefinitionView.prototype.store=function(){var b=null;if(this.isManager){b={typeId:this.typeId==null?0:this.typeId};}else{b={typeId:this.typeId==null?0:this.typeId,"Q_deployId_S_NEQ":"null","Q_status_SN_EQ":1};}var a=new Ext.data.Store({baseParams:b,proxy:new Ext.data.HttpProxy({url:__ctxPath+"/flow/listProDefinition.do"}),reader:new Ext.data.JsonReader({root:"result",totalProperty:"totalCounts",id:"id",fields:[{name:"defId",type:"int"},"proType","name","description","createtime","deployId","status","drawDefXml"]}),remoteSort:true});a.setDefaultSort("defId","desc");return a;};ProDefinitionView.prototype.topbar=function(){var a=new Ext.Toolbar({height:30,items:[]});a.add(new Ext.Button({iconCls:"btn-flow-design",text:"在线流程设计",handler:function(){window.open(__ctxPath+"/bpm/bpmDesign.do","_blank");}}));if(isGranted("_FlowAdd")){a.add(new Ext.Button({iconCls:"btn-add",text:"发布JBPM4流程",handler:function(){new ProDefinitionForm(null,ProDefinitionView.typeId);}}));}if(isGranted("_FlowDel")){a.add(new Ext.Button({iconCls:"btn-del",text:"删除流程",handler:function(){var d=Ext.getCmp("ProDefinitionGrid");var b=d.getSelectionModel().getSelections();if(b.length==0){Ext.ux.Toast.msg("信息","请选择要删除的记录！");return;}var e=Array();for(var c=0;c<b.length;c++){e.push(b[c].data.defId);}ProDefinitionView.remove(e);}}));}return a;};ProDefinitionView.remove=function(b){var a=Ext.getCmp("ProDefinitionGrid");Ext.Msg.confirm("信息确认","注意：删除该流程定义，该流程下的所有相关数据也一并删除，\n并不能恢复，您确认要删除该记录吗？",function(c){if(c=="yes"){Ext.Ajax.request({url:__ctxPath+"/flow/multiDelProDefinition.do",params:{ids:b},method:"post",success:function(){Ext.ux.Toast.msg("信息提示","成功删除所选记录！");a.getStore().reload({params:{start:0,limit:25}});}});}});};ProDefinitionView.edit=function(a){new ProDefinitionForm(a);};ProDefinitionView.view=function(a,b){var d=App.getContentPanel();var c=d.getItem("ProDefinitionDetail"+a);if(c==null){c=new ProDefinitionDetail(a,b);d.add(c);}d.activate(c);};ProDefinitionView.setting=function(a,c){var d=App.getContentPanel();var b=d.getItem("ProDefinitionSetting"+a);if(!b){b=new ProDefinitionSetting({defId:a,name:c});d.add(b);}d.activate(b);};ProDefinitionView.newFlow=function(a,c){var d=App.getContentPanel();var b=d.getItem("ProcessRunStart"+a);if(!b){b=new ProcessRunStart({id:"ProcessRunStart"+a,defId:a,flowName:c});d.add(b);}d.activate(b);};ProDefinitionView.rights=function(a){new ProDefRightsForm({defId:a}).show();};ProDefinitionView.reDesign=function(a){window.open(__ctxPath+"/bpm/bpmDesign.do?defId="+a,"flowDesign"+a);};ProDefinitionView.edit=function(a){new ProDefinitionForm(a);};