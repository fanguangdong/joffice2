Ext.ns("ProDefinitionSetting");ProDefinitionSetting=Ext.extend(Ext.Panel,{constructor:function(a){Ext.applyIf(this,a);this.initUIs();ProDefinitionSetting.superclass.constructor.call(this,{id:"ProDefinitionSetting"+this.defId,title:"流程设置－"+this.name,layout:"form",autoScroll:true,border:false,iconCls:"btn-setting",items:[this.gridPanel,this.flowImagePanel,this.formSetPanel]});},initUIs:function(){this.gridPanel=this.usersPanel(this.defId);this.flowImagePanel=new Ext.Panel({title:"流程干预设置",layout:"form",width:"100%",split:true,border:false,region:"center",autoScroll:true,collapsible:true,margin:"5 5 5 5",autoLoad:{nocache:true,url:__ctxPath+"/flow/processImage.do?defId="+this.defId}});this.useTemplateCheckbox=new Ext.form.Checkbox({boxLabel:"使用表单模板",scope:this,handler:this.setExtTemplate});this.formSetPanel=new Ext.Panel({title:"表单设置",border:false,autoScroll:true,layout:"form",tbar:[this.useTemplateCheckbox,"-",{text:"设置流程表单",iconCls:"btn-setting",scope:this,handler:this.setting.createCallback(this)},{text:"设置表单字段权限",scope:this,iconCls:"btn-setting",handler:this.setRights}],items:[]});Ext.Ajax.request({url:__ctxPath+"/flow/formTempProDefinition.do",params:{defId:this.defId},scope:this,success:function(c,b){var a=Ext.decode(c.responseText);this.mappingId=a.mappingId;this.formSetPanel.removeAll();if(a!=null&&a.isUseTemplate==1){this.useTemplateCheckbox.setValue(true);}else{this.formSetPanel.add(this.getFormPanel.call(this));}this.formSetPanel.doLayout();},failure:function(b,a){}});},getFormPanel:function(){this.formPanel=new Ext.FormPanel({autoLoad:{url:__ctxPath+"/flow/getProcessActivity.do?defId="+this.defId,scope:this,callback:this.getFormHtmlCallback}});return this.formPanel;},getFormTemplateGrid:function(){this.formTempGridPanel=new HT.EditorGridPanel({clicksToEdit:1,autoHeight:true,showPaging:false,rowActions:true,isShowTbar:false,url:__ctxPath+"/flow/mappingsFormTemplate.do?mappingId="+this.mappingId,fields:["templateId","mappingId","nodeName","formUrl","tempType"],columns:[{header:"templateId",dataIndex:"templateId",hidden:true},{header:"表单名称",dataIndex:"nodeName",width:300},{header:"模板类型",dataIndex:"tempType",width:100,renderer:function(a){if(a==2){return"URL模板";}else{return"EXT模板";}},editor:new Ext.form.ComboBox({valueField:"id",displayField:"name",store:[["1","EXT模板"],["2","URL模板"]],triggerAction:"all",editable:false})},{header:"URL",dataIndex:"formUrl",width:250,editor:new Ext.form.TextField()},new Ext.ux.grid.RowActions({header:"管理",width:100,actions:[{iconCls:"btn-form-design",qtip:"设计表单",style:"margin:0 3px 0 3px",fn:function(a){if(a.data.templateId!=null){return true;}return false;}},{iconCls:"btn-form-tag",qtip:"设置表单源码",style:"margin:0 3px 0 3px",fn:function(a){if(a.data.templateId!=null){return true;}return false;}}],listeners:{scope:this,"action":this.onRowAction}})]});return this.formTempGridPanel;},onRowAction:function(c,a,d,e,b){switch(d){case"btn-form-design":this.taskFormDesigner.call(this,a);break;case"btn-form-tag":this.vmEditor.call(this,a);break;default:break;}},taskFormDesigner:function(b){var a=new FormDesignWindow({defId:this.defId,templateId:b.data.templateId,activityName:b.data.nodeName});a.show();},vmEditor:function(a){var b=new FormEditorWindow({defId:this.defId,activityName:a.data.nodeName});b.show();},setExtTemplate:function(b,e){var a=this.formSetPanel.getTopToolbar().items;for(var c=0;c<a.getCount();c++){if(c>0){var d=a.get(c);if(e&&d.hide){d.hide();}else{if(d.show){d.show();}}}}Ext.Ajax.request({url:__ctxPath+"/flow/saveFmProDefinition.do?defId="+this.defId,params:{useTemplate:e},scope:this,success:function(h,g){var f=Ext.decode(h.responseText);this.mappingId=f.mappingId;this.formSetPanel.removeAll();if(e){this.saveTemplateBtn=new Ext.Button({iconCls:"btn-save",text:"保存模板设置",scope:this,handler:this.saveFormTemplate});this.formSetPanel.getTopToolbar().insert(1,this.saveTemplateBtn);this.formSetPanel.add(this.getFormTemplateGrid.call(this));}else{if(this.saveTemplateBtn){this.formSetPanel.getTopToolbar().remove(this.saveTemplateBtn);}this.formSetPanel.add(this.getFormPanel.call(this));}this.formSetPanel.doLayout();}});},saveFormTemplate:function(){var a=this.formTempGridPanel.getStore();var c=[];for(var b=0;b<a.getCount();b++){c.push(a.getAt(b).data);}Ext.Ajax.request({url:__ctxPath+"/flow/saveListFormTemplate.do",method:"post",params:{formTemps:Ext.encode(c)},scope:this,success:function(e,d){a.commitChanges();Ext.ux.Toast.msg("操作信息","成功保存表单设置！");}});},setRights:function(){var a=this.defId;Ext.Ajax.request({url:__ctxPath+"/flow/checkFieldRights.do",method:"post",params:{defId:a},success:function(b,d){var c=Ext.util.JSON.decode(b.responseText);if(c.success){new FieldRightsForm({defId:a}).show();}else{Ext.ux.Toast.msg("操作提示",c.msg==null?"未绑定表单！":c.msg);}},failure:function(){}});},setting:function(a){FormDefSelector.getView(function(c,b){if(c!=null){a.save(a,a.defId,c);}},a.defId).show();},save:function(b,a,c){Ext.Ajax.request({url:__ctxPath+"/flow/addFormDef.do?defId="+a+"&formDefId="+c,method:"post",waitMsg:"数据正在提交，请稍后...",success:function(e,f){var g=Ext.util.JSON.decode(e.responseText);if(g.success){Ext.ux.Toast.msg("操作提示","设置流程表单操作成功！");var d=b.formPanel;d.getUpdater().update({url:__ctxPath+"/flow/getProcessActivity.do?defId="+a,scope:b,callback:b.getFormHtmlCallback});}else{Ext.ux.Toast.msg("操作提示",g.msg);}}});},getFormHtmlCallback:function(){var c=this.formPanel.getForm().getEl().dom;var a=this.formPanel;var b=c.elements||(document.forms[c]||Ext.getDom(c)).elements;try{$converDetail.call(this,null);}catch(d){}}});ProDefinitionSetting.prototype.usersPanel=function(d){var f=new Ext.Toolbar({items:[{text:"保存",iconCls:"btn-save",handler:function(){var m=[];for(i=0,cnt=h.getCount();i<cnt;i+=1){var l=h.getAt(i);if(l.data.assignId==""||l.data.assignId==null){l.set("assignId",-1);}if(l.data.isSigned==""||l.data.isSigned==null){l.set("isSigned",0);}if(l.dirty){m.push(l.data);}}if(m.length==0){Ext.ux.Toast.msg("信息","没有对数据进行任何更改");return;}Ext.Ajax.request({method:"post",url:__ctxPath+"/flow/saveProUserAssign.do",success:function(n){Ext.ux.Toast.msg("操作信息","成功设置流程表单");h.reload();a.getView().refresh();},failure:function(n){Ext.MessageBox.show({title:"操作信息",msg:"信息保存出错，请联系管理员！",buttons:Ext.MessageBox.OK,icon:"ext-mb-error"});},params:{data:Ext.encode(m)}});}}]});var h=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:__ctxPath+"/flow/listProUserAssign.do?defId="+this.defId}),reader:new Ext.data.JsonReader({root:"result",id:"id",fields:["assignId","deployId","activityName","reJobId","reJobName","userId","username","roleId","roleName","jobId","jobName","isSigned"]})});h.load();var k=0;var c=0;var b=new Ext.form.TriggerField({triggerClass:"x-form-browse-trigger",onTriggerClick:function(l){UserSelector.getView(function(o,p){var n=a.getStore();var m=n.getAt(k);m.set("userId",o);m.set("username",p);},false,true).show();a.stopEditing();}});var j=new Ext.form.TriggerField({triggerClass:"x-form-browse-trigger",onTriggerClick:function(l){RoleSelector.getView(function(o,p){var n=a.getStore();var m=n.getAt(k);m.set("roleId",o);m.set("roleName",p);},true).show();a.stopEditing();}});var e=new Ext.form.TriggerField({triggerClass:"x-form-browse-trigger",onTriggerClick:function(n){var m=a.getStore();var l=m.getAt(k);RelativeJobSelector.getView(function(o,p){l.set("reJobId",o);l.set("reJobName",p);},false).show();a.stopEditing();}});var g=new Ext.form.TriggerField({triggerClass:"x-form-browse-trigger",onTriggerClick:function(l){JobSelector.getView(function(o,p){var n=a.getStore();var m=n.getAt(k);m.set("jobId",o);m.set("jobName",p);},false).show();a.stopEditing();}});var a=new Ext.grid.EditorGridPanel({title:"人员设置",id:"ProDefinitionSettingGrid"+this.defId,autoHeight:true,clicksToEdit:1,store:h,tbar:f,columns:[new Ext.grid.RowNumberer(),{header:"assignId",dataIndex:"assignId",hidden:true},{header:"deployId",dataIndex:"deployId",hidden:true},{header:"流程任务",dataIndex:"activityName",width:100,sortable:true},{dataIndex:"userId",header:"userId",hidden:true},{header:"用户",dataIndex:"username",width:150,sortable:true,editor:b},{dataIndex:"roleId",hidden:true},{header:"角色",dataIndex:"roleName",width:150,editor:j},{header:"岗位",dataIndex:"jobName",width:150,editor:g},{header:"jobId",dataIndex:"jobId",hidden:true},{header:"上下级",dataIndex:"reJobName",width:150,editor:e},{header:"reJobId",dataIndex:"reJobId",hidden:true},{header:"是否会签",dataIndex:"isSigned",width:150,renderer:function(l){return l==1?"是":"否";},editor:new Ext.form.ComboBox({valueField:"id",displayField:"name",store:[["0","否"],["1","是"]],triggerAction:"all",editable:false})},{header:"会签设置",dataIndex:"isSigned",width:150,renderer:function(p,o,l,r,n){var m=l.get("assignId");var q=l.get("activityName");return p==1?'<button class="btn-setting" title ="会签设置" onclick="ProDefinitionSetting.setTaskAssign('+m+",'"+q+"')\"/>":"";}}]});a.on("cellclick",function(l,o,m,n){k=o;});return a;};ProDefinitionSetting.clickNode=function(a,c,b){$ImportSimpleJs([__ctxPath+"/js/flow/ProcessNodeSetting.js"],function(){new ProcessNodeSetting({defId:a,activityName:c,nodeType:b}).show();},this);};ProDefinitionSetting.roleSelect=function(e,c,a){var d=Ext.getCmp("ProDefinitionSettingGrid"+a);var b=d.getStore().getAt(e);d.getStore().reload();d.doLayout();};ProDefinitionSetting.setTaskAssign=function(a,b){new TaskSignForm({assignId:a,activityName:b}).show();};