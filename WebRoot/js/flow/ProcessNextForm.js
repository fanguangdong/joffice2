ProcessNextForm=Ext.extend(Ext.Panel,{constructor:function(c){Ext.applyIf(this,c);var a=false;Ext.Ajax.request({params:{taskId:this.taskId},async:false,scope:this,url:__ctxPath+"/flow/checkTask.do",success:function(e,f){var d=Ext.util.JSON.decode(e.responseText);if(!this.agentTask){if(d.assigned!=undefined){if(!d.assigned){Ext.ux.Toast.msg("操作信息","该任务已经被其他用户锁定执行！");a=true;}else{if(d.assigned){Ext.ux.Toast.msg("操作信息","该任务已经成功锁定!");}}}}this.isSubFlow=d.isSubFlow?d.isSubFlow:false;}});if(a){var b=Ext.getCmp("TaskPanelView");if(b!=null&&b!=undefined){b.getUpdater().update(__ctxPath+"/flow/displayTask.do");}return;}this.assignTasks=new Array();this.assignUserIds=new Array();this.formPanel=new Ext.FormPanel({border:false,bodyStyle:"padding:8px",autoHeight:true,autoLoad:{url:__ctxPath+"/flow/getProcessActivity.do?taskId="+this.taskId,nocache:true,params:{activityName:this.activityName},scope:this,callback:this.getFormHtmlCallback}});this.flowdetailPanel=new Ext.Panel({border:false,autoHeight:true,autoLoad:{url:__ctxPath+"/flow/processRunDetail.do?taskId="+this.taskId,nocache:true}});this.userJumpPanel=new Ext.form.FieldSet({title:"选择下一任务执行人",collapsed:true,autoHeight:true,collapsed:false,collapsible:true,layout:"form"});this.jumpPanel=new Ext.Panel({border:false,bodyStyle:"padding:8px",layout:"form",items:[this.userJumpPanel]});this.toolbar=new Ext.Toolbar({items:[" "," ",{xtype:"checkbox",boxLabel:"自由跳转",scope:this,handler:this.freeJump},"-",{xtype:"button",text:"执行下一步",scope:this,iconCls:"btn-transition",handler:this.nextStep},"-",{xtype:"checkbox",boxLabel:"发送邮件",scope:this,handler:function(d,e){if(e){this.sendMail=true;}else{this.sendMail=false;}}},{xtype:"checkbox",boxLabel:"发送短信",scope:this,handler:function(d,e){if(e){this.sendMsg=true;}else{this.sendMsg=false;}}},"->","-",{text:"打印",iconCls:"btn-print",scope:this,handler:function(){gpObj=document.getElementById("ProcessNextForm_"+this.taskId);printFlag=true;fckeditorIframe=null;var e=gpObj.getElementsByTagName("iframe");for(var d=0;d<e.length;d++){if(e[d].id.indexOf("fckeditor")!=-1){fckeditorIframe=e[d];}}window.open(__ctxPath+"/js/printer/Print.jsp");}},"->","-",{text:"流程示意图",iconCls:"btn-flow-chart",scope:this,handler:this.showFlowImage}]});this.loadJumpTrans.call(this);ProcessNextForm.superclass.constructor.call(this,{tbar:this.toolbar,id:"ProcessNextForm_"+this.taskId,iconCls:"btn-approvalTask",title:this.activityName+"--待办事项",layout:"form",bodyStyle:"padding:5px",items:[this.jumpPanel,this.formPanel,this.flowdetailPanel]});},loadJumpTrans:function(){Ext.Ajax.request({url:__ctxPath+"/flow/transProcessActivity.do",params:{taskId:this.taskId},scope:this,success:function(a,c){var b=Ext.decode(a.responseText);if(b.preTaskName!=undefined&&b.preTaskName!=""){if(!this.jumpBackButton){this.jumpBackButton=new Ext.Button({text:"驳回",iconCls:"btn-back",scope:this,handler:this.backFlow});this.toolbar.insert(3,new Ext.Toolbar.Separator());this.toolbar.insert(3,this.jumpBackButton);this.unAddBack=true;this.preTaskName=b.preTaskName;}}var e=[];for(var d=0;d<b.data.length;d++){e.push({boxLabel:b.data[d].destination,name:"jumpPath_"+this.taskId,inputValue:b.data[d].name,destType:b.data[d].destType,destName:b.data[d].destination,checked:d==0?true:false});}this.jumpRadioGroup=new Ext.form.RadioGroup({listeners:{scope:this,"change":this.jumpRadioCheck},fieldLabel:"执行路径",items:e});this.jumpPanel.insert(0,this.jumpRadioGroup);this.jumpPanel.doLayout();this.jumpRadioCheck.call(this);if(b.isSignTask){this.addSignVoteOpinion.call(this);}}});},addSignVoteOpinion:function(){this.voteRadioGroup=new Ext.form.RadioGroup({columns:[100,100,100],vertical:true,items:[{xtype:"radio",name:"signVoteType",boxLabel:"同意",inputValue:1,checked:true},{name:"signVoteType",xtype:"radio",boxLabel:"拒绝",inputValue:2},{xtype:"radio",name:"signVoteType",boxLabel:"弃权",inputValue:0}]});this.voteCmpField=new Ext.form.CompositeField({width:540,autoHeight:true,fieldLabel:"会签投票意见",items:[this.voteRadioGroup]});this.voteListPanel=new Ext.Panel({border:false,autoHeight:true,autoLoad:{url:__ctxPath+"/flow/signListProcessActivity.do?taskId="+this.taskId,nocache:true}});this.voteSignFieldSet=new Ext.form.FieldSet({title:"会签情况",autoHeight:true,layout:"form",items:[this.voteListPanel,this.voteCmpField]});},jumpRadioCheck:function(b,a){if(!b){b=this.jumpRadioGroup;}if(!a){a=b.getValue();}this.getTaskUsers.call(this,a.destName,a.destType);this.getDueDatePanel.call(this,a.destType);},getDueDatePanel:function(b){if(!this.dueDatePanel){var a=new Date();a.setHours(a.getHours()+4);this.dueDatePanel=new Ext.Panel({layout:"form",width:400,border:false,items:[{xtype:"datetimefield",fieldLabel:"完成限定时间",name:"dueDate",width:240,format:"Y-m-d H:i:s",value:a}]});this.jumpPanel.add(this.dueDatePanel);this.jumpPanel.doLayout();}if(b=="task"){this.dueDatePanel.show();}else{this.dueDatePanel.hide();}},getTaskUsers:function(a,b){if("decision"==b||"fork"==b||"join"==b){this.userJumpPanel.removeAll();this.userJumpPanel.show();this.genForkDecUserAssign.call(this,a);}else{if(b.indexOf("end")!=-1){if(this.isSubFlow){this.getOutToParentFlow.call(this);}this.userJumpPanel.removeAll();this.userJumpPanel.hide();}else{this.userJumpPanel.removeAll();this.userJumpPanel.show();this.userJumpPanel.add(this.getSingleUserPanel.call(this,a));}}this.jumpPanel.doLayout();},getParentFlowTaskUsers:function(a,b){if("decision"==b||"fork"==b||"join"==b){this.userJumpPanel.removeAll();this.userJumpPanel.show();this.genForkDecUserAssign.call(this,a,true);}else{if(b.indexOf("end")!=-1){this.userJumpPanel.removeAll();this.userJumpPanel.hide();}else{this.userJumpPanel.removeAll();this.userJumpPanel.show();this.userJumpPanel.add(this.getSingleUserPanel.call(this,a,true));}}},parentJumpPathComboSelect:function(e,a,b){var c=a.data.destination;var d=a.data.destType;this.getParentFlowTaskUsers.call(this,c,d);this.userJumpPanel.doLayout();},getOutToParentFlow:function(){this.parentJumpPathCombo=new Ext.form.ComboBox({allowBlank:true,store:new Ext.data.JsonStore({autoLoad:true,url:__ctxPath+"/flow/parentTransProcessActivity.do?taskId="+this.taskId,fields:["destType","destination","name"],root:"data"}),fieldLabel:"跳至父流程路径",mode:"local",editable:false,triggerAction:"all",displayField:"destination",valueField:"name",listeners:{scope:this,"select":this.parentJumpPathComboSelect}});this.jumpPanel.insert(1,this.parentJumpPathCombo);this.jumpPanel.doLayout();},getSingleUserPanel:function(b,a){this.flowAssignName=new Ext.form.TextArea({width:400,height:40,name:"flowAssignName"});var c=new Ext.form.CompositeField({xtype:"compositefield",fieldLabel:"执行人",anchor:"92%,92%",items:[this.flowAssignName,{xtype:"button",scope:this,text:"...",iconCls:"btn-users",handler:function(){var d=this.flowUserFieldPanel;UserSelector.getView({callback:function(f,e){this.flowAssignName.setValue(e);this.assignTasks=[b];this.assignUserIds=[f];},scope:this}).show();}}]});Ext.Ajax.request({url:__ctxPath+"/flow/usersProcessActivity.do",scope:this,params:{taskId:this.taskId,activityName:b,isParentFlow:a},success:function(e,f){var d=Ext.decode(e.responseText);this.flowAssignName.setValue(d.userNames);this.assignTasks=[b];this.assignUserIds=[d.userIds];}});return c;},genForkDecUserAssign:function(b,a){Ext.Ajax.request({url:__ctxPath+"/flow/outerTransProcessActivity.do?taskId="+this.taskId,params:{nodeName:b,isParentFlow:a},scope:this,success:function(f,c){var e=Ext.decode(f.responseText);for(var d=0;d<e.length;d++){this.userJumpPanel.add(this.genUserFieldSel.call(this,e[d]),d);}this.userJumpPanel.doLayout();}});},genUserFieldSel:function(d,b){var c=d[1];this.assignTasks[b]=c;this.assignUserIds[b]=d[3];var a=new Ext.form.TextArea({allowBlank:false,width:400,height:40,value:d[4]});var e=new Ext.form.CompositeField({anchor:"92%,92%",bodyStyle:"background-color:white;padding:0 0 0 0",fieldLabel:c,items:[a,{xtype:"button",text:"...",iconCls:"btn-users",scope:this,handler:function(){UserSelector.getView({scope:this,callback:function(f,j){a.setValue(j);var g=this.assignTasks.length;for(var h=g-1;h>=0;h--){if(this.assignTasks[h]==c){g=h;break;}}this.assignTasks[g]=c;this.assignUserIds[g]=f;}}).show();}}]});return e;},getFlowAssignId:function(){var a="";var d="";var c="";for(var b=0;b<this.assignTasks.length;b++){if(b>0){d+=":";c+=":";}d+=this.assignTasks[b];c+=this.assignUserIds[b];}if(d!=""){a=d+"|"+c;}return a;},nextStep:function(){var w=true;if(this.formExtPanel!=null&&this.formExtPanel.validate){w=this.formExtPanel.validate.call(this.formExtPanel,this);}else{w=$validForm.call(this);}if(!w){return;}var u="";var C="";var h=null;if(this.isFreeJump){u=this.freeTransCombo.getValue();var n=this.freeTransCombo.getStore();for(var y=0;y<n.getCount();y++){var I=n.getAt(y).data;if(I.signalName==u){C=I.destName;break;}}}else{var b=this.jumpRadioGroup.getValue();u=b.getGroupValue();C=b.destName;}if(C==""){Ext.ux.Toast.msg("操作信息","请选择要跳转的目标任务！");return;}if(this.voteRadioGroup){h=this.voteRadioGroup.getValue().getGroupValue();}var c=this.formPanel.getForm();var k=this.officePanel;if(k){var s=null;if(this.fileId!=""&&this.fileId!=undefined){s=k.saveDoc({docName:"ProcessDocument",fileId:this.fileId,doctype:"doc"});}else{s=k.saveDoc({docName:"ProcessDocument",doctype:"doc"});}if(s&&s.success){var H=s.fileId;this.hiddenF.setValue(H);}}var m="";if(this.formExtPanel!=null&&this.formExtPanel.getFlowAssignId){m=this.formExtPanel.getFlowAssignId.call(this.formExtPanel,this);}else{m=this.getFlowAssignId.call(this);}var p={useTemplate:this.useTemplate,signVoteType:h,flowAssignId:m,taskId:this.taskId,signalName:u,destName:C,sendMsg:this.sendMsg,sendMail:this.sendMail};if(this.dueDatePanel.show()){var F=this.dueDatePanel.getCmpByName("dueDate").getValue();p.dueDate=$formatDate(F);}if(this.parentJumpPathCombo){if(this.parentJumpPathCombo.getValue()==""){Ext.ux.Toast.msg("操作信息","请选择回跳至父流程的节点!");return;}p.toParentPath=this.parentJumpPathCombo.getValue();}if(this.detailGrids){var l=this.detailGrids.keys;for(var x=0;x<l.length;x++){var B=[];var r=this.detailGrids.get(l[x]);var n=r.getStore();for(var y=0;y<n.getCount();y++){var e=n.getAt(y);var E=HT.encode(e.data);B.push(E);}p[l[x]+"details"]=Ext.encode(B);}}var z=c.getEl().dom;var g=z.getElementsByTagName("form");var t=[];var q=new Ext.util.MixedCollection();for(var y=0;y<g.length;y++){var f=g[y].getAttribute("belongName");var J=g[y].getAttribute("pkName");var A=g[y].getAttribute("pkValue");var D=Ext.Ajax.serializeForm(g[y]);var v=Ext.urlDecode(D);if(J&&A){v[J]=A;}var G=HT.encode(v);var a=q.get(f);if(!a){var B=[];B.push(G);q.add(f,B);}else{a.push(G);}}for(var y=0;y<q.keys.length;y++){var o=q.keys[y];p[o+"details"]=Ext.encode(q.get(o));}if(c.isValid()){c.submit({url:__ctxPath+"/flow/nextProcessActivity.do",method:"post",waitMsg:"正在提交处理，请稍等",scope:this,params:p,success:function(d,j){Ext.ux.Toast.msg("操作信息","成功保存！");AppUtil.removeTab("ProcessNextForm_"+this.taskId);var K=Ext.getCmp("MyTaskGrid");var i=Ext.getCmp("TaskPanelView");if(i!=null){i.getUpdater().update(__ctxPath+"/flow/displayTask.do");}if(K!=null){K.getStore().reload();}if(k){k.closeDoc();}},failure:function(d,i){Ext.ux.Toast.msg("操作信息","操作出错，请联系管理员！");}});}},freeJump:function(a,b){if(b){this.isFreeJump=true;this.jumpPanel.remove(this.jumpRadioGroup);this.freeTransCombo=new Ext.form.ComboBox({fieldLabel:"跳转任务",xtype:"combo",allowBlank:false,editable:false,lazyInit:false,triggerAction:"all",listeners:{scope:this,select:function(g,c,d){var e=c.data.destName;var f=c.data.destType;this.getTaskUsers.call(this,e,f);}},store:new Ext.data.ArrayStore({autoLoad:true,url:__ctxPath+"/flow/freeTransProcessActivity.do?taskId="+this.taskId,fields:["signalName","destName","destType"]}),displayField:"destName",valueField:"signalName"});this.jumpPanel.insert(0,this.freeTransCombo);this.jumpPanel.doLayout();}else{this.isFreeJump=false;this.jumpPanel.remove(this.freeTransCombo);this.loadJumpTrans.call(this);}},backFlow:function(){Ext.Msg.confirm("信息确认","您确认要回退所选记录吗？",function(a){if(a=="yes"){this.formPanel.getForm().submit({url:__ctxPath+"/flow/nextProcessActivity.do",scope:this,params:{useTemplate:this.useTemplate,taskId:this.taskId,destName:this.preTaskName,back:"true"},success:function(b,c){Ext.ux.Toast.msg("操作信息","成功回退！");AppUtil.removeTab("ProcessNextForm_"+this.taskId);},failture:function(b,c){Ext.ux.Toast.msg("操作信息","回退失败！");}});}},this);},getFormHtmlCallback:function(){if(this.voteSignFieldSet){this.formPanel.add(this.voteSignFieldSet);}this.formPanel.add(new Ext.form.TextArea({name:"comments",anchor:"70%,70%",fieldLabel:"审批意见"}));var formExt=document.getElementById("formTaskExt"+this.taskId);if(formExt!=null){this.useTemplate=true;var valExt=formExt.value;valExt=valExt.replace("Ext.form.FormPanel","Ext.Panel");var vmParams="{taskId:"+this.taskId+"}";this.formExtPanel=eval("new ("+valExt+")("+vmParams+");");if(this.formExtPanel.afterLoad){this.formExtPanel.afterLoad.call(this.formExtPanel,this);}this.formExtPanel.outerFormPanel=this.formPanel;this.formPanel.add(this.formExtPanel);this.formPanel.doLayout();return;}this.formPanel.doLayout();try{var json=document.getElementById("entity_"+this.taskId);var rights=document.getElementById("rightstask_"+this.taskId);var name,type,value,xtype;var callback=function(){var entityJson=null;if(json!=null&&json.value){entityJson=Ext.decode(json.value);}var rightJson=null;if(rights!=null){rightJson=Ext.decode(rights.value);}$converDetail.call(this,entityJson,rightJson);};$ImportSimpleJs([__ctxPath+"/js/core/ntkoffice/NtkOfficePanel.js",__ctxPath+"/js/selector/SealSelector.js",__ctxPath+"/js/selector/PaintTemplateSelector.js"],callback,this);}catch(e){}},showFlowImage:function(){var b=new Ext.Panel({autoHeight:true,border:false,html:'<img src="'+__ctxPath+"/jbpmImage?taskId="+this.taskId+"&rand="+Math.random()+'"/>'});var a=new Ext.Panel({autoHeight:true,layout:"form",border:false,items:[b]});if(this.isSubFlow){a.add({xtype:"panel",autoHeight:true,border:false,html:'<img src="'+__ctxPath+"/jbpmImage?taskId="+this.taskId+"&isSubFlow=true&rand="+Math.random()+'"/>'});a.doLayout();}new Ext.Window({autoScroll:true,iconCls:"btn-flow-chart",bodyStyle:"background-color:white",maximizable:true,title:"流程示意图",width:800,height:600,modal:true,layout:"fit",items:a}).show();}});