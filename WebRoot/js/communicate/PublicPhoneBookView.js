Ext.DataView.DragSelector=function(f){f=f||{};var i,h,k;var d,j,l=new Ext.lib.Region(0,0,0,0);var b=f.dragSafe===true;this.init=function(p){i=p;i.on("render",o);};function m(){d=[];i.all.each(function(p){d[d.length]=p.getRegion();});j=i.el.getRegion();}function e(){return false;}function g(p){return !b||p.target==i.el.dom;}function n(p){i.on("containerclick",e,i,{single:true});if(!h){h=i.el.createChild({cls:"x-view-selector"});}else{if(h.dom.parentNode!==i.el.dom){i.el.dom.appendChild(h.dom);}h.setDisplayed("block");}m();i.clearSelections();}function c(v){var z=k.startXY;var D=k.getXY();var B=Math.min(z[0],D[0]);var A=Math.min(z[1],D[1]);var C=Math.abs(z[0]-D[0]);var t=Math.abs(z[1]-D[1]);l.left=B;l.top=A;l.right=B+C;l.bottom=A+t;l.constrainTo(j);h.setRegion(l);for(var s=0,u=d.length;s<u;s++){var p=d[s];var q=l.intersect(p);if(q&&!p.selected){p.selected=true;i.select(s,true);}else{if(!q&&p.selected){p.selected=false;i.deselect(s);}}}}function a(p){if(!Ext.isIE){i.un("containerclick",e,i);}if(h){h.setDisplayed(false);}}function o(p){k=new Ext.dd.DragTracker({onBeforeStart:g,onStart:n,onDrag:c,onEnd:a});k.initEl(p.el);}};Ext.ns("PublicPhoneBookView");PublicPhoneBookView=Ext.extend(Ext.Panel,{treePanel:null,phoneBookView:null,selectedNode:null,dataView:null,searchPanel:null,store:null,phoneBookPanel:null,constructor:function(a){Ext.applyIf(this,a);this.initUI();PublicPhoneBookView.superclass.constructor.call(this,{title:"公共通讯薄",iconCls:"menu-personal-phoneBook",layout:"border",id:"PublicPhoneBookView",height:800,items:[this.treePanel,this.phoneBookView]});},initUI:function(){this.toolbar=new Ext.Toolbar({items:[{xtype:"button",iconCls:"btn-refresh",text:"刷新",scope:this,handler:function(){this.treePanel.root.reload();}},{xtype:"button",text:"展开",iconCls:"btn-expand",scope:this,handler:function(){this.treePanel.expandAll();}},{xtype:"button",text:"收起",scope:this,iconCls:"btn-collapse",handler:function(){this.treePanel.collapseAll();}}]});this.treePanel=new Ext.tree.TreePanel({region:"west",id:"leftPublicBookPanel",title:"通讯簿分类",collapsible:true,split:true,width:160,height:800,tbar:this.toolbar,loader:new Ext.tree.TreeLoader({url:__ctxPath+"/communicate/listPhoneGroup.do?isPublic=true"}),root:new Ext.tree.AsyncTreeNode({expanded:true}),rootVisible:false,listeners:{scope:this,"click":this.clickNode}});this.treePanel.on("contextmenu",this.contextmenu,this);this.searchPanel=new Ext.FormPanel({height:40,region:"north",frame:false,border:false,layout:"hbox",layoutConfig:{padding:"5",align:"middle"},defaults:{xtype:"label",margins:{top:0,right:4,bottom:4,left:4}},items:[{text:"请输入查询条件:"},{text:"姓名"},{xtype:"textfield",name:"Q_fullname_S_LK"},{text:"称谓"},{xtype:"textfield",name:"Q_title_S_LK",xtype:"combo",anchor:"95%",mode:"local",triggerAction:"all",store:["先生","女士"]},{xtype:"button",text:"查询",iconCls:"search",handler:this.search.createCallback(this)},{xtype:"hidden",name:"Q_phoneGroup.isPublic_SN_EQ",value:1}]});this.store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:__ctxPath+"/communicate/listPhoneBook.do"}),baseParams:{"Q_phoneGroup.isPublic_SN_EQ":1},reader:new Ext.data.JsonReader({root:"result",totalProperty:"totalCounts",id:"id",fields:[{name:"phoneId",type:"int"},"fullname","title","birthday","nickName","duty","spouse","childs","companyName","companyAddress","companyPhone","companyFax","homeAddress","homeZip","mobile","phone","email","qqNumber","msn","note","userId","groupId","isShared"]}),remoteSort:true});this.store.setDefaultSort("phoneId","desc");this.store.load({params:{start:0,limit:15}});this.dataView=new Ext.DataView({store:this.store,tpl:new Ext.XTemplate('<tpl for=".">','<div class="thumb-wrap" id="{phoneId}">',"<span><font>姓名&nbsp;：</font>{fullname}</span>","<span><font>手机&nbsp;：</font>{mobile}</span>","<span><font>电话&nbsp;：</font>{phone}</span>","<span><font>Email：</font>{email}</span>","<span><font>QQ&nbsp;&nbsp;&nbsp;：</font>{qqNumber}</span>","<span><font>MSN&nbsp;&nbsp;：</font>{msn}</span>","</div>","</tpl>"),autoScroll:true,multiSelect:true,overClass:"x-view-over",itemSelector:"div.thumb-wrap",emptyText:"目前尚无记录",plugins:[new Ext.DataView.DragSelector()],listeners:{"dblclick":{fn:this.editRecord.createCallback(this),scope:this},"contextmenu":{fn:this.showMenu,scope:this}}});this.toolbar=new Ext.Toolbar({height:28,bodyStyle:"text-align:left",items:[{iconCls:"btn-add",xtype:"button",text:"添加公共联系人",handler:this.createRecord},{iconCls:"btn-del",xtype:"button",text:"删除公共联系人",handler:this.deleteRecord.createCallback(this)}]});this.phoneBookPanel=new Ext.Panel({region:"center",tbar:this.toolbar,layout:"fit",items:this.dataView,bbar:new Ext.PagingToolbar({pageSize:15,store:this.store,displayInfo:true,displayMsg:"当前显示从{0}至{1}， 共{2}条记录",emptyMsg:"当前没有记录"})});this.phoneBookView=new Ext.Panel({title:"联系人列表",region:"center",layout:"border",items:[this.searchPanel,this.phoneBookPanel]});},clickNode:function(c){if(c!=null){var b=this.phoneBookView;if(c.id==0){b.setTitle("所有联系人");}else{b.setTitle(c.text+"组列表");}var a=this.dataView.getStore();a.url=__ctxPath+"/communicate/listPhoneBook.do";a.baseParams={"Q_phoneGroup.groupId_L_EQ":c.id>0?c.id:"","Q_phoneGroup.isPublic_SN_EQ":1};a.reload({params:{start:0,limit:15}});}},contextmenu:function(a,b){var c=new Ext.menu.Menu({items:[{text:"新建组",scope:this,iconCls:"btn-add",handler:this.createNode},{text:"修改组",scope:this,iconCls:"btn-edit",handler:this.editNode},{text:"删除组",scope:this,iconCls:"btn-delete",handler:this.deleteNode}]});this.selectedNode=new Ext.tree.TreeNode({id:a.id,text:a.text});c.showAt(b.getXY());},createNode:function(){new PublicPhoneGroupForm().show();},editNode:function(){var a=this.selectedNode.id;if(a>0){new PublicPhoneGroupForm({groupId:a}).show();}else{Ext.MessageBox.show({title:"操作信息",msg:"该处不能被修改",buttons:Ext.MessageBox.OK,icon:"ext-mb-error"});}},deleteNode:function(){var b=this.selectedNode.id;var c=this.treePanel;var a=this.phoneBookView;Ext.Ajax.request({url:__ctxPath+"/communicate/countPhoneGroup.do",params:{"Q_phoneGroup.groupId_L_EQ":b},method:"post",success:function(d,f){var e=Ext.util.JSON.decode(d.responseText).count;Ext.Msg.confirm("删除操作","组里还有"+e+"个联系人，你确定删除目录组吗?",function(g){if(g=="yes"){Ext.Ajax.request({url:__ctxPath+"/communicate/multiDelPhoneGroup.do",params:{ids:b},method:"post",success:function(h,j){Ext.ux.Toast.msg("操作信息","成功删除目录！");c.root.reload();var i=a.dataView.getStore();i.reload({params:{start:0,limit:15}});},failure:function(h,i){Ext.MessageBox.show({title:"操作信息",msg:"信息保存出错，请联系管理员！",buttons:Ext.MessageBox.OK,icon:"ext-mb-error"});}});}});},failure:function(d,e){}});},upMove:function(){var a=this.selectedNode.id;this.moveTO(this.treePanel,a,1);},downMove:function(){var a=this.selectedNode.id;this.moveTO(this.treePanel,a,2);},topMove:function(){var a=this.selectedNode.id;this.moveTO(this.treePanel,a,3);},underMove:function(){var a=this.selectedNode.id;this.moveTO(this.treePanel,a,4);},moveTO:function(b,a,c){Ext.Ajax.request({url:__ctxPath+"/communicate/movePhoneGroup.do",params:{groupId:a,optId:c},method:"post",success:function(d,e){b.root.reload();},failure:function(d,e){}});},search:function(c){var a=c.searchPanel;if(a.getForm().isValid()){var b=c.dataView.getStore();var e=Ext.Ajax.serializeForm(a.getForm().getEl());var d=Ext.urlDecode(e);d.start=0;d.limit=15;b.baseParams=d;c.phoneBookPanel.getBottomToolbar().moveFirst();}},showMenu:function(a,c,f,h){var b=a.getSelectedNodes();if(b.length<2){a.all.each(function(e){a.deselect(e);});a.select(c,true);}b=a.getSelectedNodes();if(b!=""&&b!=null&&b!="undefined"){var d=new Array();if(b.length==1){d.push({text:"修改",scope:this,iconCls:"btn-edit",handler:this.editRecord.createCallback(this)});}d.push({text:"删除",scope:this,iconCls:"btn-delete",handler:this.deleteRecord.createCallback(this)});var g=new Ext.menu.Menu({items:d});g.showAt(h.getXY());}},createRecord:function(){new PhoneBookForm({isPublic:true}).show();},editRecord:function(b){var a=b.dataView.getSelectedNodes();if(a!=""&&a!=null&&a!="undefined"){var c=a[0].id;new PhoneBookForm({phoneId:c,isPublic:true}).show();}},deleteRecord:function(c){var b=c.dataView.getSelectedNodes();var a=c.dataView.getStore();if(b!=""&&b!=null&&b!="undefined"){var e=new Array();for(var d=0;d<b.length;d++){e.push(b[d].id);}Ext.Msg.confirm("信息确认","您确认要删除该记录吗？",function(f){if(f=="yes"){Ext.Ajax.request({url:__ctxPath+"/communicate/multiDelPhoneBook.do",params:{ids:e},method:"post",success:function(){Ext.ux.Toast.msg("信息提示","成功删除所选记录！");a.reload({params:{start:0,limit:15}});}});}});}else{Ext.ux.Toast.msg("信息提示","请选择删除记录！");}}});