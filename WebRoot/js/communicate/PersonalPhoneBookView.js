Ext.ns("PersonalPhoneBookView");PersonalPhoneBookView=Ext.extend(Ext.Panel,{treePanel:null,phoneBookView:null,selectedNode:null,constructor:function(a){Ext.applyIf(this,a);this.initUI();PersonalPhoneBookView.superclass.constructor.call(this,{title:"我的通讯薄",iconCls:"menu-personal-phoneBook",layout:"border",id:"PersonalPhoneBookView",height:800,items:[this.treePanel,this.phoneBookView]});},initUI:function(){this.phoneBookView=new PhoneBookView();this.toolbar=new Ext.Toolbar({items:[{xtype:"button",iconCls:"btn-refresh",text:"刷新",scope:this,handler:function(){this.treePanel.root.reload();}},{xtype:"button",text:"展开",iconCls:"btn-expand",scope:this,handler:function(){this.treePanel.expandAll();}},{xtype:"button",text:"收起",scope:this,iconCls:"btn-collapse",handler:function(){this.treePanel.collapseAll();}}]});this.treePanel=new Ext.tree.TreePanel({region:"west",id:"leftBookPanel",title:"我的通讯分组",collapsible:true,split:true,width:160,height:800,tbar:this.toolbar,loader:new Ext.tree.TreeLoader({url:__ctxPath+"/communicate/listPhoneGroup.do"}),root:new Ext.tree.AsyncTreeNode({expanded:true}),rootVisible:false,listeners:{scope:this,"click":this.clickNode}});this.treePanel.on("contextmenu",this.contextmenu,this);},clickNode:function(c){if(c!=null){var b=this.phoneBookView;if(c.id==0){b.setTitle("所有联系人");}else{b.setTitle(c.text+"组列表");}var a=b.dataView.getStore();a.url=__ctxPath+"/communicate/listPhoneBook.do";a.baseParams={"Q_phoneGroup.groupId_L_EQ":c.id>0?c.id:"","Q_appUser.userId_L_EQ":curUserInfo.userId,"Q_phoneGroup.isPublic_SN_EQ":0};a.reload({params:{start:0,limit:15}});}},contextmenu:function(a,b){var c=new Ext.menu.Menu({items:[{text:"新建组",scope:this,iconCls:"btn-add",handler:this.createNode},{text:"修改组",scope:this,iconCls:"btn-edit",handler:this.editNode},{text:"删除组",scope:this,iconCls:"btn-delete",handler:this.deleteNode},{text:"上移",scope:this,iconCls:"btn-up",handler:this.upMove},{text:"下移",scope:this,iconCls:"btn-last",handler:this.downMove},{text:"置顶",scope:this,iconCls:"btn-top",handler:this.topMove},{text:"置底",scope:this,iconCls:"btn-down",handler:this.underMove}]});this.selectedNode=new Ext.tree.TreeNode({id:a.id,text:a.text});c.showAt(b.getXY());},createNode:function(){new PhoneGroupForm({isPublic:0}).show();},editNode:function(){var a=this.selectedNode.id;if(a>0){new PhoneGroupForm({groupId:a,isPublic:0}).show();}else{Ext.MessageBox.show({title:"操作信息",msg:"该处不能被修改",buttons:Ext.MessageBox.OK,icon:"ext-mb-error"});}},deleteNode:function(){var b=this.selectedNode.id;var c=this.treePanel;var a=this.phoneBookView;Ext.Ajax.request({url:__ctxPath+"/communicate/countPhoneGroup.do",params:{"Q_phoneGroup.groupId_L_EQ":b},method:"post",success:function(d,f){var e=Ext.util.JSON.decode(d.responseText).count;Ext.Msg.confirm("删除操作","组里还有"+e+"个联系人，你确定删除目录组吗?",function(g){if(g=="yes"){Ext.Ajax.request({url:__ctxPath+"/communicate/multiDelPhoneGroup.do",params:{ids:b},method:"post",success:function(h,j){Ext.ux.Toast.msg("操作信息","成功删除目录！");c.root.reload();var i=a.dataView.getStore();i.reload({params:{start:0,limit:15}});},failure:function(h,i){Ext.MessageBox.show({title:"操作信息",msg:"信息保存出错，请联系管理员！",buttons:Ext.MessageBox.OK,icon:"ext-mb-error"});}});}});},failure:function(d,e){}});},upMove:function(){var a=this.selectedNode.id;this.moveTO(this.treePanel,a,1);},downMove:function(){var a=this.selectedNode.id;this.moveTO(this.treePanel,a,2);},topMove:function(){var a=this.selectedNode.id;this.moveTO(this.treePanel,a,3);},underMove:function(){var a=this.selectedNode.id;this.moveTO(this.treePanel,a,4);},moveTO:function(b,a,c){Ext.Ajax.request({url:__ctxPath+"/communicate/movePhoneGroup.do",params:{groupId:a,optId:c},method:"post",success:function(d,e){b.root.reload();},failure:function(d,e){}});}});