DepWorkPlanForm=Ext.extend(Ext.Window,{formPanel:null,buttons:null,constructor:function(a){Ext.applyIf(this,a);this.initUI();DepWorkPlanForm.superclass.constructor.call(this,{id:"DepWorkPlanWin",iconCls:"menu-depplan",layout:"border",region:"center",title:"我的计划详细信息",items:this.formPanel,modal:true,width:770,minWidth:750,height:600,minHeight:600,maximizable:true,keys:{key:Ext.EventObject.ENTER,fn:this.saveRecord,scope:this},buttonAlign:"center",buttons:this.buttons});},initUI:function(){this.formPanel=new Ext.FormPanel({url:__ctxPath+"/task/saveWorkPlan.do",frame:false,border:false,layout:"form",region:"center",id:"DepWorkPlanForm",defaults:{padding:"5"},formId:"DepWorkPlanFormId",items:[{name:"workPlan.planId",id:"planId",xtype:"hidden",value:this.planId==null?"":this.planId},{name:"issueScopeIds",id:"issueScopeIds",xtype:"hidden"},{name:"participantsIds",id:"participantsIds",xtype:"hidden"},{name:"principalIds",id:"principalIds",xtype:"hidden"},{name:"workPlan.isPersonal",value:0,xtype:"hidden"},{name:"workPlan.proTypeId",xtype:"hidden",id:"proTypeId"},{xtype:"panel",layout:"form",border:false,width:680,defaultType:"textfield",bodyStyle:"padding-top:10px",defaults:{border:false},items:[{xtype:"compositefield",fieldLabel:"计划类型",items:[{name:"workPlan.typeName",id:"typeName",xtype:"textfield",width:445,readOnly:true,allowBlank:false},{xtype:"button",text:"选择类型",iconCls:"btn-select",handler:function(){new GlobalTypeSelector({catKey:"DEPWORKPLAN",isSingle:true,callback:function(b,a){Ext.getCmp("proTypeId").setValue(b);Ext.getCmp("typeName").setValue(a);}}).show();}}]},{fieldLabel:"计划名称",name:"workPlan.planName",width:520,allowBlank:false,id:"planName"},{xtype:"container",border:false,layout:"hbox",layoutConfig:{padding:"0",align:"middle"},defaults:{xtype:"label",margins:{top:0,right:4,bottom:4,left:0}},items:[{text:"时间范围:",width:101,style:"padding-left:0px;padding-top:3px;"},{xtype:"datetimefield",width:250,format:"Y-m-d H:i:s",allowBlank:false,editable:false,name:"workPlan.startTime",id:"startTime"},{text:" 至 ",style:"padding-left:0px;padding-top:3px;",width:8},{xtype:"datetimefield",width:253,format:"Y-m-d H:i:s",allowBlank:false,editable:false,name:"workPlan.endTime",id:"endTime"}]},{fieldLabel:"计划内容",name:"workPlan.planContent",xtype:"htmleditor",height:180,width:520,allowBlank:false,id:"planContent"},{layout:"column",style:"padding-left:0px;",width:670,border:false,xtype:"container",items:[{columnWidth:0.83,border:false,style:"padding-left:0px;",layout:"form",items:[{fieldLabel:"附件",xtype:"panel",frame:false,id:"planFilePanel",height:45,autoScroll:true,html:""}]},{columnWidth:0.17,border:false,items:[{xtype:"button",iconCls:"menu-attachment",text:"添加附件",handler:function(){var a=App.createUploadDialog({file_cat:"task/plan/depWorkPlan",callback:function(e){var b=Ext.getCmp("planFileIds");var d=Ext.getCmp("planFilePanel");for(var c=0;c<e.length;c++){if(b.getValue()!=""){b.setValue(b.getValue()+",");}b.setValue(b.getValue()+e[c].fileId);Ext.DomHelper.append(d.body,'<span><a href="#" onclick="FileAttachDetail.show('+e[c].fileId+')">'+e[c].fileName+'</a> <img class="img-delete" src="'+__ctxPath+'/images/system/delete.gif" onclick="removeResumeFile(this,'+e[c].fileId+')"/>&nbsp;|&nbsp;</span>');}}});a.show(this);}},{xtype:"button",iconCls:"reset",text:"清除附件",handler:function(){var b=Ext.getCmp("planFileIds");var a=Ext.getCmp("planFilePanel");a.body.update("");b.setValue("");}},{xtype:"hidden",id:"planFileIds",name:"planFileIds"}]}]},{xtype:"container",id:"IssueScopeContainer",style:"padding-left:0px;padding-bottom:3px;",layout:"column",items:[{xtype:"label",style:"padding-left:0px;",text:"发布范围:",width:105},{xtype:"textfield",name:"workPlan.issueScope",id:"issueScope",readOnly:true,width:402},{xtype:"button",text:"选择部门",iconCls:"btn-select",handler:function(){DepSelector.getView(function(b,a){Ext.getCmp("issueScope").setValue(a);Ext.getCmp("issueScopeIds").setValue(b);}).show();}},{xtype:"button",text:"清除记录"}]},{xtype:"container",id:"AttendContainer",layout:"column",style:"padding-left:0px;padding-bottom:3px;",items:[{xtype:"label",text:"参与人:",style:"padding-left:0px;",width:105},{xtype:"textfield",name:"workPlan.participants",id:"participants",readOnly:true,width:402},{xtype:"button",text:"选择人员",iconCls:"btn-select",handler:function(){UserSelector.getView(function(b,a){Ext.getCmp("participants").setValue(a);Ext.getCmp("participantsIds").setValue(b);}).show();}},{xtype:"button",text:"清除记录"}]},{xtype:"container",layout:"column",id:"PrincipalContainer",style:"padding-left:0px;padding-bottom:3px;",items:[{xtype:"label",text:"负责人:",style:"padding-left:0px;",width:105},{xtype:"textfield",name:"workPlan.principal",id:"principal",readOnly:true,width:402},{xtype:"button",text:"选择人员",iconCls:"btn-select",handler:function(){UserSelector.getView(function(b,a){Ext.getCmp("principal").setValue(a);Ext.getCmp("principalIds").setValue(b);}).show();}},{xtype:"button",text:"清除记录"}]},{xtype:"radiogroup",fieldLabel:"是否启用",autoHeight:true,columns:2,width:520,items:[{boxLabel:"是",name:"workPlan.status",inputValue:1,id:"status1",checked:true},{boxLabel:"否",name:"workPlan.status",inputValue:0,id:"status0"}]},{fieldLabel:"标识",hiddenName:"workPlan.icon",id:"icon",xtype:"iconcomb",mode:"local",allowBlank:false,width:520,editable:false,store:new Ext.data.SimpleStore({fields:["flagStyle","flagName"],data:[["ux-flag-blue","日常计划"],["ux-flag-orange","重要计划"],["ux-flag-green","特殊计划"],["ux-flag-pink","个人计划"],["ux-flag-red","紧急计划"],["ux-flag-purple","部门计划"],["ux-flag-yellow","待定计划"]]}),valueField:"flagStyle",displayField:"flagName",triggerAction:"all",value:"ux-flag-blue"},{fieldLabel:"备注",name:"workPlan.note",xtype:"textarea",id:"note",width:520,height:50}]}]});this.buttons=[{text:"保存",iconCls:"btn-save",scope:this,handler:this.saveRecord},{text:"关闭",iconCls:"btn-cancel",scope:this,handler:this.closeWin}];if(this.planId!=""&&this.planId!=null&&this.planId!=undefined){this.formPanel.getForm().load({url:__ctxPath+"/task/getWorkPlan.do?planId="+this.planId,waitMsg:"正在载入数据...",success:function(b,d){var m=Ext.util.JSON.decode(d.response.responseText);var j=m.data;var a=m.proTypeId;Ext.getCmp("proTypeId").setValue(a);var c=j.startTime;var e=j.status;Ext.getCmp("status"+e).setValue(true);var g=j.endTime;var k=j.planFiles;Ext.getCmp("startTime").setValue(new Date(getDateFromFormat(c,"yyyy-MM-dd H:mm:ss")));Ext.getCmp("endTime").setValue(new Date(getDateFromFormat(g,"yyyy-MM-dd H:mm:ss")));var h=Ext.getCmp("planFilePanel");var l=Ext.getCmp("planFileIds");for(var f=0;f<k.length;f++){if(l.getValue()!=""){l.setValue(l.getValue()+",");}l.setValue(l.getValue()+k[f].fileId);Ext.DomHelper.append(h.body,'<span><a href="#" onclick="FileAttachDetail.show('+k[f].fileId+')">'+k[f].fileName+'</a><img class="img-delete" src="'+__ctxPath+'/images/system/delete.gif" onclick="removeResumeFile(this,'+k[f].fileId+')"/>&nbsp;|&nbsp;</span>');}},failure:function(a,b){Ext.ux.Toast.msg("编辑","载入失败");}});}},saveRecord:function(){var b=this.formPanel;var e=this;var d=Ext.getCmp("issueScope").getValue();var a=Ext.getCmp("participants").getValue();var c=Ext.getCmp("principal").getValue();if((d!="")||a!=""){if(c!=""){if(b.getForm().isValid()){b.getForm().submit({method:"post",waitMsg:"正在提交数据...",success:function(f,g){Ext.ux.Toast.msg("操作信息","成功保存信息！");Ext.getCmp("DepWorkPlanGrid").getStore().reload();e.close();},failure:function(f,g){Ext.MessageBox.show({title:"操作信息",msg:"信息保存出错，请联系管理员！",buttons:Ext.MessageBox.OK,icon:"ext-mb-error"});e.close();}});}}else{Ext.ux.Toast.msg("操作提示","负责人为必填!");}}else{Ext.ux.Toast.msg("操作提示","发布范围，参与人至少填写一项!");}},closeWin:function(){this.close();}});function removeResumeFile(e,a){var b=Ext.getCmp("planFileIds");var d=b.getValue();if(d.indexOf(",")<0){b.setValue("");}else{d=d.replace(","+a,"").replace(a+",","");b.setValue(d);}var c=Ext.get(e.parentNode);c.remove();}