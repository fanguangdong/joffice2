Ext.ns("DepWorkPlanView");DepWorkPlanView=Ext.extend(Ext.Panel,{searchFormPanel:null,gridPanel:null,constructor:function(a){Ext.applyIf(this,a);this.initUI();DepWorkPlanView.superclass.constructor.call(this,{id:"DepWorkPlanView",title:"部门计划列表",iconCls:"menu-depplan",region:"center",layout:"border",items:[this.searchFormPanel,this.gridPanel]});},initUI:function(){this.searchFormPanel=new Ext.FormPanel({height:40,region:"north",frame:false,border:false,layout:"hbox",layoutConfig:{padding:"5",align:"middle"},defaults:{xtype:"label",margins:{top:0,right:4,bottom:4,left:4}},items:[{text:"请输入查询条件:"},{text:"计划名称"},{xtype:"textfield",name:"workPlan.planName"},{text:"计划类型"},{xtype:"textfield",name:"workPlan.typeName"},{text:"负责人"},{xtype:"textfield",name:"workPlan.principal"},{xtype:"button",text:"查询",iconCls:"search",scope:this,handler:this.search},{xtype:"button",text:"重置",scope:this,handler:function(){this.searchFormPanel.getForm().reset();}}]});var b=new Ext.grid.CheckboxSelectionModel();var a=new Ext.grid.ColumnModel({columns:[b,new Ext.grid.RowNumberer(),{header:"planId",dataIndex:"planId",hidden:true},{header:"标识",dataIndex:"icon",renderer:function(c){return'<div class="'+c+'"></div>';}},{header:"计划名称",dataIndex:"planName"},{header:"开始日期",dataIndex:"startTime"},{header:"结束日期",dataIndex:"endTime"},{header:"计划类型",dataIndex:"globalType",renderer:function(c){if(c!=null){return c.typeName;}}},{header:"创建人",dataIndex:"userName"},{header:"发布范围",dataIndex:"issueScope"},{header:"负责人",dataIndex:"principal"},{header:"是否生效",dataIndex:"startTime",renderer:function(i,g,c,j,f){var h=new Date(getDateFromFormat(i,"yyyy-MM-dd H:mm:ss"));var e=new Date(getDateFromFormat(c.data.endTime,"yyyy-MM-dd H:mm:ss"));var d=new Date();if(h>d){return'<a style="color:blue;">未生效</a>';}else{if(h<=d&&e>=d){return'<a style="color:green;">已生效</a>';}else{if(e<d){return'<a style="color:red;">已失效</a>';}}}}}],defaults:{sortable:true,menuDisabled:false,width:100}});this.store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:__ctxPath+"/task/departmentWorkPlan.do"}),reader:new Ext.data.JsonReader({root:"result",totalProperty:"totalCounts",id:"id",fields:[{name:"planId",type:"int"},"planName","planContent","startTime","endTime","globalType","appUser",{name:"userName",mapping:"appUser.fullname"},"issueScope","participants","principal","note","status","isPersonal","icon"]}),remoteSort:true});this.store.setDefaultSort("planId","desc");this.store.load({params:{start:0,limit:25}});this.topbar=new Ext.Toolbar({items:[{xtype:"button",text:"添加部门计划",iconCls:"btn-add",handler:this.createRecord},{xtype:"button",text:"编辑部门计划",iconCls:"btn-edit",scope:this,handler:this.editRecord},{xtype:"button",text:"删除",iconCls:"btn-del",scope:this,handler:this.delRecords}]});this.gridPanel=new Ext.grid.GridPanel({id:"DepWorkPlanGrid",tbar:this.topbar,store:this.store,region:"center",trackMouseOver:true,disableSelection:false,loadMask:true,cm:a,sm:b,viewConfig:{forceFit:true,enableRowBody:false,showPreview:false},bbar:new HT.PagingBar({store:this.store})});this.gridPanel.addListener("rowdblclick",this.rowdblclickaction);},search:function(){var a=this.searchFormPanel;var b=this.gridPanel;if(a.getForm().isValid()){$search({searchPanel:a,gridPanel:b});}},rowdblclickaction:function(b,a,c){b.getSelectionModel().each(function(d){new WorkPlanDetail({planId:d.data.planId,planName:d.data.planName}).show();});},createRecord:function(){new DepWorkPlanForm().show();},editRecord:function(){var a=this.gridPanel.getSelectionModel().getSelections();if(a.length==0){Ext.ux.Toast.msg("操作信息","请选择要编辑的记录");return;}else{if(a.length>1){Ext.ux.Toast.msg("操作信息","只可以编辑一条记录");return;}}var b=a[0];if(b.data.appUser.userId==curUserInfo.userId){new DepWorkPlanForm({planId:b.data.planId,planName:b.data.planName}).show();}else{Ext.ux.Toast.msg("操作信息","你无权修改此记录");return;}},delRecords:function(){var b=this.gridPanel.getSelectionModel().getSelections();if(b.length==0){Ext.ux.Toast.msg("操作信息","请选择要删除的记录");return;}var d=[];var a=false;for(var c=0;c<b.length;c++){var e=b[c];if(e.data.appUser.userId==curUserInfo.userId){d.push(e.data.planId);}else{a=true;}}if(a){Ext.ux.Toast.msg("操作信息","只有当前用户创建的记录才能被删除！");return;}$postDel({url:__ctxPath+"/task/multiDelWorkPlan.do",ids:d,grid:this.gridPanel});}});