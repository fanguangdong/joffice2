Ext.ns("Ht");Ht.detailGrid=Ext.extend(Ext.grid.EditorGridPanel,{constructor:function(a){Ext.applyIf(this,a);this.parentConf=this.parentConf;this.initUI();Ht.detailGrid.superclass.constructor.call(this,{stripeRows:true,tbar:this.toolbar,store:this.store,width:800,trackMouseOver:true,disableSelection:false,loadMask:true,clicksToEdit:1,anchor:"100% -53",autoScroll:true,cm:this.cm,sm:this.sm,viewConfig:{autoFill:true},listeners:{scope:this,"render":function(b){b.dragZone=new Ext.ux.dd.GridDragZone(b,{});b.dropZone=new Ext.ux.dd.GridDropZone(b,{});},"rowclick":function(c,b,d){this.clickRow=b;},"beforeedit":function(c){var b=c.record;if(b.data.isDesignShow!=3){if(c.field=="fieldName"||c.field=="fieldLabel"||c.field=="fieldSize"||c.field=="fieldType"||c.field=="isRequired"||c.field=="showFormat"||c.field=="isPrimary"){return false;}}}}});},initUI:function(){var a=[{name:"fieldId",type:"int"},"fieldName","fieldType","fieldLabel","isRequired","fieldSize","fieldDscp","isPrimary","foreignKey","foreignTable","isList","isQuery","isFlowTitle","showFormat","isDesignShow"];if(this.isMainTable){a=[{name:"fieldId",type:"int"},"fieldName","fieldType","fieldLabel","isRequired","fieldSize","fieldDscp","isPrimary","isList","isQuery","isFlowTitle","showFormat","isDesignShow"];}this.store=new Ext.data.JsonStore({fields:a,remoteSort:false});this.store.setDefaultSort("fieldId","asc");this.toolbar=new Ext.Toolbar({items:[{xtype:"button",text:"添加字段",iconCls:"btn-add",handler:this.addField,scope:this},{xtype:"button",text:"删除字段",iconCls:"btn-del",handler:this.delField,scope:this}]});this.sm=new Ext.grid.CheckboxSelectionModel();var b=[this.sm,new Ext.grid.RowNumberer(),{header:"fieldId",dataIndex:"fieldId",hidden:true},{header:"字段KEY",width:100,dataIndex:"fieldName",editor:new Ext.form.TextField({listeners:{scope:this,"change":this.changeForeignKey}})},{header:"字段标签",width:100,dataIndex:"fieldLabel",editor:new Ext.form.TextField()},{header:"字段长度",width:100,dataIndex:"fieldSize",xtype:"numbercolumn",format:"0",editor:new Ext.form.TextField()},{header:"字段类型",width:100,dataIndex:"fieldType",editor:new Ext.form.ComboBox({typeAhead:true,triggerAction:"all",lazyRender:true,mode:"local",store:["varchar","bigint","smallint","int","text","date","datetime","double","float","char","decimal","file"],listeners:{scope:this,"change":this.changeMainTablePrimaryKey}})},{header:"显示格式",width:100,dataIndex:"showFormat",editor:new Ext.form.TextField()},{header:"是否主键",width:100,dataIndex:"isPrimary",xtype:"templatecolumn",tpl:new Ext.XTemplate('<p><input type="checkbox" <tpl if="isPrimary ==1">checked="checked"</tpl> onclick="return false;" class="x-form-checkbox x-form-field"/></p>'),editor:{xtype:"checkbox",listeners:{scope:this,"change":function(c,d){this.fireEvent("clickPrimary",{isMainTable:this.isMainTable==true?true:false,curGrid:this,clickIndex:this.clickRow,checked:d});}}}}];if(this.isMainTable==true){b.push({header:"是否为节点标题",width:100,dataIndex:"isFlowTitle",xtype:"templatecolumn",tpl:new Ext.XTemplate('<p><input type="checkbox" <tpl if="isFlowTitle ==1">checked="checked"</tpl> onclick="return false;" class="x-form-checkbox x-form-field"/></p>'),editor:{xtype:"checkbox",listeners:{scope:this,"change":this.changeTitle}}});}b.push({header:"是否必填",width:100,dataIndex:"isRequired",xtype:"templatecolumn",tpl:new Ext.XTemplate('<p><input type="checkbox" <tpl if="isRequired ==1">checked="checked"</tpl> onclick="return false;" class="x-form-checkbox x-form-field"/></p>'),editor:{xtype:"checkbox",inputValue:1}});b.push({header:"是否显示",width:100,dataIndex:"isList",xtype:"templatecolumn",tpl:new Ext.XTemplate('<p><input type="checkbox" <tpl if="isList ==1">checked="checked"</tpl> onclick="return false;" class="x-form-checkbox x-form-field"/></p>'),editor:{xtype:"checkbox",inputValue:1}});b.push({header:"是否查询",width:100,dataIndex:"isQuery",xtype:"templatecolumn",tpl:new Ext.XTemplate('<p><input type="checkbox" <tpl if="isQuery ==1">checked="checked"</tpl> onclick="return false;" class="x-form-checkbox x-form-field"/></p>'),editor:{xtype:"checkbox",inputValue:1}});if(this.isMainTable!=true){b.push({header:"外键字段",width:100,dataIndex:"foreignKey",editor:new Ext.form.ComboBox({typeAhead:true,triggerAction:"all",mode:"local",store:new Ext.data.JsonStore({fields:["fieldName"]}),valueField:"fieldName",displayField:"fieldName",listeners:{scope:this,"focus":function(h){var e=this.parentConf.editGrid1.getStore();var c=this.getStore();var d=[];for(var f=0;f<e.getCount();f++){var j=e.getAt(f);var g=c.getAt(this.clickRow);if(j.data.fieldType==g.data.fieldType){d.push(j.data);}}h.getStore().loadData(d);},"select":function(g,c,e){var d=this.getStore();var h=d.getAt(this.clickRow);if(h){var f=this.configPanel.getCmpByName("formTable.tableKey").getValue();h.set("foreignTable",f);}}}})});b.push({header:"关联表",width:100,dataIndex:"foreignTable",editor:new Ext.form.TextField()});}this.cm=new Ext.grid.ColumnModel({columns:b,defaults:{sortable:false,width:100,fixed:true,menuDisabled:true}});},changeTitle:function(b,e){if(this.isMainTable){var d=this.clickRow;var a=this.getStore();if(e){for(var c=0;c<a.getCount();c++){var f=a.getAt(c);if(c!=d){if(f.data.isFlowTitle==1||f.data.isFlowTitle==true||f.data.isFlowTitle=="1"||f.data.isFlowTitle=="true"){f.set("isFlowTitle",0);}}else{f.set("isFlowTitle",1);}}}else{var f=a.getAt(d);f.set("isFlowTitle",0);}}},changeMainTablePrimaryKey:function(g){if(this.isMainTable==true&&this.parentConf){var a=this.parentConf.primarykeyRecord;if(a){for(var e=0;e<this.parentConf.SubTables.keys.length;e++){var d=this.parentConf.SubTables.keys[e];var c=this.parentConf.dataStore.get(d+"-grid");var b=c.getStore();var f=this.parentConf.findForeignKey(b,a.data.fieldName);if(f){f.set("fieldType",g.getValue());f.commit();}}}}},changeForeignKey:function(h,g,b){if(this.isMainTable==true&&this.parentConf){for(var e=0;e<this.parentConf.SubTables.keys.length;e++){var d=this.parentConf.SubTables.keys[e];var c=this.parentConf.dataStore.get(d+"-grid");var a=c.getStore();var f=this.parentConf.findForeignKey(a,b);if(f){f.set("foreignKey",g);f.commit();}}}},addField:function(){var c=this.store;var b=c.recordType;var a=new b();a.set("isPrimary",0);a.set("isList",0);a.set("isQuery",0);a.set("isRequired",0);a.set("isDesignShow",3);a.set("isFlowTitle",0);c.insert(c.getCount(),a);this.getView().refresh();},delField:function(){var c=this.getSelectionModel().getSelections();if(c.length==0){Ext.ux.Toast.msg("操作信息","请选择要删除的字段！");return;}var b=this.getStore();for(var d=0;d<c.length;d++){var a=c[d];if(this.isMainTable&&a.data.isPrimary==1){this.primarykeyRecord=null;b.fireEvent("removePrimaryKey",{grid:this,record:a});}b.remove(a);}this.getView().refresh();}});Ht.DetailFormPanel=Ext.extend(Ext.form.FieldSet,{constructor:function(a){Ext.applyIf(this,a);this.initUI();Ht.DetailFormPanel.superclass.constructor.call(this,{layout:"form",collapsible:true,collapsed:false,title:this.title,flex:1,items:[{xtype:"hidden",name:this.paramRoot+".isMain",value:0},{xtype:"hidden",name:this.paramRoot+".tableId"},{xtype:"textfield",name:this.paramRoot+".tableName",anchor:"100%",allowBlank:false,fieldLabel:"表名"},{xtype:"textfield",name:this.paramRoot+".tableKey",anchor:"100%",value:this.paramRoot,readOnly:true,allowBlank:false,fieldLabel:"表KEY"},this.editGrid]});},initUI:function(){if(this.defaultGrid){this.editGrid=this.defaultGrid;}else{this.editGrid=new Ht.detailGrid({parentConf:this.parentConf});}this.editGrid.on("render",function(a){a.dragZone=new Ext.ux.dd.GridDragZone(a,{});a.dropZone=new Ext.ux.dd.GridDropZone(a,{});},this);},getEditGrid:function(){return this.editGrid;}});FormDesignPanelForm=Ext.extend(Ext.Window,{designPanel:null,showPanel:null,step:0,activePanel:null,SubTables:new Ext.util.MixedCollection(),MainTable:null,editGrid1:null,clickRow:-1,havadetailNo:0,formTables:[],primarykeyRecord:null,caStore:null,cacheTable:[],haveSub:false,subTableKeys:[],isOldPublish:"",constructor:function(a){Ext.applyIf(this,a);this.initUI();FormDesignPanelForm.superclass.constructor.call(this,{id:"FormDesignPanelForm",title:"表单设计",iconCls:"menu-form",width:850,height:500,modal:true,maximizable:true,layout:"vbox",defaults:{padding:"6"},layoutConfig:{align:"stretch"},items:[this.designPanel,this.configPanel],buttonAlign:"center",buttons:this.buttons});},initUI:function(){this.caStore=new Ext.util.MixedCollection();this.dataStore=new Ext.util.MixedCollection();this.radioGroup=new Ext.form.RadioGroup({fieldLabel:"表模式",allowBlank:false,anchor:"94%",name:"formDef.formType",items:[{name:"formDef.formType",boxLabel:"单表",inputValue:0},{name:"formDef.formType",boxLabel:"一对多表",inputValue:1}]});this.designPanel=new Ext.FormPanel({url:__ctxPath+"/flow/saveFormDef.do",layout:"form",region:"north",defaults:{},flex:1,autoScroll:true,items:[{xtype:"hidden",name:"formDef.formDefId",value:this.formDefId?this.formDefId:""},{xtype:"textfield",name:"formDef.formTitle",allowBlank:false,fieldLabel:"表单名称",anchor:"96%"},{xtype:"textarea",name:"formDef.formDesp",fieldLabel:"表单描述",anchor:"96%"},{xtype:"hidden",name:"formDef.status",fieldLabel:"表单状态",value:0},{xtype:"hidden",name:"formDef.isGen",value:0},this.radioGroup,{hideLabel:true,anchor:"96%",height:496,xtype:"fckdesigner",allowBlank:false,blankText:"请设计好表单!",name:"formDef.defHtml"}]});this.activePanel=this.designPanel;this.editGrid2=new Ht.detailGrid({parentConf:this});this.editGrid1=new Ht.detailGrid({isMainTable:true,parentConf:this});this.editGrid1.on("clickPrimary",this.addPrimaryKey,this);this.mainTable=new Ext.form.FieldSet({layout:"form",title:"主表",border:true,flex:1,items:[{xtype:"hidden",name:"formTable.isMain",value:1},{xtype:"hidden",name:"formTable.tableId"},{xtype:"textfield",allowBlank:false,name:"formTable.tableName",anchor:"100%",fieldLabel:"表名"},{xtype:"textfield",name:"formTable.tableKey",anchor:"100%",allowBlank:false,fieldLabel:"表KEY",listeners:{"change":this.changeForeignTable,scope:this}},this.editGrid1]});this.belongTable=new Ext.form.FieldSet({flex:1,title:"子表",layout:"form",defaults:{anchor:"96% 100%"},autoScroll:true,items:[]});this.configPanel=new Ext.FormPanel({hidden:true,flex:1,region:"center",layout:"hbox",layoutConfig:{padding:"3 3 3 3",align:"stretch"},items:[this.mainTable,this.belongTable]});this.seebutton=new Ext.Button({text:"预览",iconCls:"btn-detail",handler:this.checkDesign,scope:this});this.savebutton=new Ext.Button({hidden:true,text:"保存",iconCls:"btn-save",handler:this.saveDrafRecord,scope:this});this.publishbutton=new Ext.Button({hidden:true,text:"发布",iconCls:"btn-save",handler:this.publishRecord,scope:this});this.upbutton=new Ext.Button({hidden:true,text:"上一步",iconCls:"btn-save",handler:this.upStep,scope:this});this.nextbutton=new Ext.Button({text:"下一步",iconCls:"btn-save",handler:this.nextStep,scope:this});this.buttons=[this.seebutton,this.savebutton,this.publishbutton,this.upbutton,this.nextbutton,{xtype:"button",text:"关闭",iconCls:"btn-cancel",scope:this,handler:function(){this.close();}}];this.dataStore.add("mainGrid",this.editGrid1);var c=this.editGrid1.getStore();this.dataStore.add("mainGrid-store",c);if(this.formDefId!=null&&this.formDefId!="undefined"){var a=this.designPanel;var b=this;this.designPanel.loadData({url:__ctxPath+"/flow/getFormDef.do?formDefId="+this.formDefId,root:"data",preName:"formDef",success:function(d,e){var f=Ext.util.JSON.decode(d.responseText).data;a.getCmpByName("formDef.defHtml").setValue(f.defHtml);b.formTables=f.formTables;}});}else{this.radioGroup.setValue(0);}},changeForeignTable:function(h,g,b){for(var e=0;e<this.SubTables.keys.length;e++){var d=this.SubTables.keys[e];var c=this.dataStore.get(d+"-grid");var a=c.getStore();var f=this.findForeignKey(a,this.primarykeyRecord.data.fieldName);if(f){f.set("foreignTable",g);f.commit();}}},checkDesign:function(){var a=this.designPanel.getCmpByName("formDef.defHtml").getValue();new DesignerWin({defHtml:a}).show();},findForeignKey:function(a,c){if(c){for(var b=0;b<a.getCount();b++){var d=a.getAt(b);if(d.data.foreignKey==c){return d;}}}return null;},findPrimaryKey:function(a){for(var b=0;b<a.getCount();b++){var c=a.getAt(b);if(c.data.isPrimary==1){return c;}}return null;},addPrimaryKey:function(h){var a=h.curGrid;var k=a.getStore();var g=h.clickIndex;var c,j;if(h.checked){for(var f=0;f<k.getCount();f++){var e=k.getAt(f);if(f!=g){if(e.data.isPrimary==1||e.data.isPrimary==true||e.data.isPrimary=="1"||e.data.isPrimary=="true"){e.set("isPrimary",0);c=e;}}else{e.set("isPrimary",1);j=e;this.primarykeyRecord=e;}}}else{c=k.getAt(g);c.set("isPrimary",0);}if(this.haveSub&&h.isMainTable){for(var f=0;f<this.subTableKeys.length;f++){var b=this.subTableKeys[f];var d=this.dataStore.get(b+"-grid");this.addForeignKey(d,j,c);}}},addForeignKey:function(f,g,d){var c=f.getStore();var a=this.configPanel.getCmpByName("formTable.tableKey").getValue();for(var e=0;e<c.getCount();e++){var b=c.getAt(e);if(d&&b.data.foreignKey&&b.data.foreignKey==d.data.fieldName){if(b.data.foreignTable==a||b.data.foreignTable==""||b.data.foreignTable==null){if(g){b.set("fieldType",g.data.fieldType);b.set("foreignKey",g.data.fieldName);b.set("fieldLabel","Foreign_Key");if(a!=b.data.foreignTable){b.set("foreignTable",a);}return;}else{c.remove(b);f.getView().refresh();return;}}}}if(!d&&g){this.addForeignKeyRecord(f,g);return;}},addForeignKeyRecord:function(b,d){var a=b.getStore();a.commitChanges();var f=d.data.fieldName;d=d.copy();d.store=null;Ext.data.Record.id(d);d.set("fieldId",null);d.set("fieldName","f"+f);d.set("foreignKey",f);d.set("fieldLabel","Foreign_Key");d.set("isPrimary",0);d.set("foreignTable",this.configPanel.getCmpByName("formTable.tableKey").getValue());d.commit();try{a.add(d);}catch(c){}try{b.getView().refresh();}catch(c){}},addPrimaryKeyRecord:function(d,g){var c=d.getStore();var b=c.recordType;var a=new b();a.set("fieldName",g);a.set("fieldType","bigint");a.set("fieldLabel","Primary_Key");a.set("isPrimary",1);a.set("isList",0);a.set("isQuery",0);a.set("isRequired",0);a.set("isDesignShow",3);a.set("isFlowTitle",0);c.insert(c.getCount(),a);try{d.getView().refresh();}catch(f){}return a;},upStep:function(){this.activePanel.hide();this.activePanel=this.designPanel;this.activePanel.show();this.upbutton.hide();this.doLayout(true);this.step=0;this.nextbutton.show();this.publishbutton.hide();this.savebutton.hide();},nextStep:function(){var a=this.designPanel.getCmpByName("formDef.defHtml").getValue();if(this.checkIfHasSameElement(this.getFormElements(this.getHtmlForm(a)))){Ext.ux.Toast.msg("信息提示","字段名称不能重复,请检查重新命名！");return;}if(this.step==0&&this.activePanel.getForm().isValid()){var b=this.radioGroup.getValue();if(b.inputValue==0){this.haveSub=false;this.belongTable.hide();if(a){var c=this.loadFields(a,true);if(c!=false){Ext.ux.Toast.msg("信息提示",c);return;}}}else{this.haveSub=true;if(a){var c=this.loadFields(a,false);if(c!=false){Ext.ux.Toast.msg("信息提示",c);return;}}this.belongTable.show();}this.activePanel.hide();this.activePanel=this.configPanel;this.activePanel.show();this.upbutton.show();this.savebutton.show();this.publishbutton.show();this.nextbutton.hide();this.configPanel.doLayout(true);this.doLayout(true);this.step=1;}else{Ext.ux.Toast.msg("信息提示","没填写表单信息或未设计表单！");return;}},getHtmlForm:function(d){var a=document.createElement("form");var e=document.createElement("p");var c=document.createElement("div");var b=Ext.DomHelper.insertHtml("afterBegin",c,d);e.appendChild(c);a.appendChild(e);return a;},getFormElements:function(a){return a.elements;},checkIfHasSameElement:function(c){for(var b=0;b<c.length;b++){for(var a=b+1;a<c.length;a++){if(c[b].name==c[a].name&&c[b].type!="radio"&&c[b].type!="checkbox"){return true;}}}return false;},enHtml:function(f){var u=function(x){var y=new Object();y.fieldName=x.name;var w=x.getAttribute("txtvaluetype");y.fieldType=w?w:"varchar";var z=x.getAttribute("txtisprimary");y.isPrimary=z==1?1:0;var i=x.getAttribute("txtlabel");y.fieldLabel=i?i:x.name;var k=x.getAttribute("txtisnotnull");y.isRequired=k==1?1:0;var j=x.getAttribute("txtsize");y.fieldSize=j?j:null;var v=x.getAttribute("dataformat");y.showFormat=v?v:"";y.isList=1;y.isQuery=1;y.isDesignShow=x.type=="hidden"?2:1;y.isisFlowTitle=0;return y;};var m=function(y){var k=[];for(var x=0;x<y.length;x++){var z=y[x];var v=true;for(var w=0;w<k.length;w++){if(k[w].name==z.name){v=false;}}if(v){k.push(z);}}return k;};var a=function(i){var v=[];var w=[];Ext.each(i,function(x){if(x.type=="button"){return;}if(x.type=="radio"||x.type=="checkbox"){w.push(x);return;}v.push(u(x));});var j=m(w);for(var k=0;k<j.length;k++){v.push(u(j[k]));}return v;};var l=this.getHtmlForm(f);var b=l.getElementsByTagName("TABLE");this.havadetailNo=0;this.SubTables.clear();this.MainTable=null;var p=new Ext.util.MixedCollection();var d=[];var o=[];if(this.haveSub){for(var r=0;r<b.length;r++){if(b[r]&&b[r].getAttribute("isdetail")){var g=b[r].getAttribute("txtname");if(!g){return"明细表格未填写名字!";}for(var q=0;q<o.length;q++){if(o[q]==g){return"子表存在重复表名，请保证表名不相同！";}}p.add(g,b[r]);o.push(g);this.subTableKeys.push(g);d.push(b[r]);this.havadetailNo++;}}if(d&&d.length>0){for(var r=0;r<d.length;r++){var c=d[r].parentNode;if(c){c.removeChild(d[r]);}}}}var t=a(l.elements);if(t.length>0){this.MainTable=t;}if(o&&o.length>0){for(var n=0;n<o.length;n++){var h=document.createElement("form");var e=p.get(o[n]);h.appendChild(e);var s=a(h.elements);if(s.length>0){this.SubTables.add(o[n],s);}}}return true;},loaddata:function(b){if(!b.data){b.data=new Array();}var c=this.dataStore.get(b.gridKey+"-store");var g=this.caStore.get(b.gridKey);if(g&&g.length>0){for(var e=0;e<g.length;e++){b.data.push(g[e]);}}var f=[];if(b.isMainTable){var a=this.dataStore.get("mainTable-database");if(a){this.setValue(this.mainTable,"formTable",a);f=a.formFields;}}var h=this.mergeDate(b.data,f);c.loadData(h);c.fireEvent("checkloadevent",{gridKey:b.gridKey,isMainTable:b.isMainTable});this.loadsubtabledata();},mergeDate:function(h,e){var b=0;var g=[];if(e&&e.length>0){for(var d=0;d<h.length;d++){var f=false;for(var c=0;c<e.length;c++){if(h[d].fieldName==e[c].fieldName){var l=e[c];var a=h[d];a.fieldId=l.fieldId;a.isPrimary=l.isPrimary;a.isFlowTitle=l.isFlowTitle;a.isQuery=l.isQuery;a.isList=l.isList;a.foreignKey=l.foreignKey;a.foreignTable=l.foreignTable;g.push(a);f=true;}else{if(b==0&&e[c].isDesignShow==3){g.push(e[c]);f=true;}}}if(!f){g.push(h[d]);}b++;}}else{g=h;}return g;},loadsubtabledata:function(){for(var g=0;g<this.subTableKeys.length;g++){var f=this.SubTables.get(this.subTableKeys[g]);var h=this.caStore.get(this.subTableKeys[g]);if(h&&h.length>0){for(var g=0;g<h.length;g++){f.push(h[g]);}}var c=this.dataStore.get(this.subTableKeys[g]+"-database");var b=[];if(c){this.setValue(this.belongTable,this.subTableKeys[g],c);b=c.formFields;}var a=this.mergeDate(f,b);var e=this.dataStore.get(this.subTableKeys[g]+"-store");e.loadData(a);this.checkdata({gridKey:this.subTableKeys[g],isMainTable:false});}},checkdata:function(f){var a=this.dataStore.get(f.gridKey+"-store");if(f.isMainTable){this.primarykeyRecord=this.findPrimaryKey(a);}else{var c=this.findPrimaryKey(a);var b=this.dataStore.get(f.gridKey+"-grid");if(b){if(this.haveSub&&c==null){this.addPrimaryKeyRecord(b,"subId");var e=this.findForeignKey(this.dataStore.get(f.gridKey+"-store"),this.primarykeyRecord.data.fieldName);this.addForeignKey(b,this.primarykeyRecord,e,true);}}}if(!this.primarykeyRecord){this.primarykeyRecord=this.addPrimaryKeyRecord(this.dataStore.get(f.gridKey),"mainId");}},setCacheFields:function(a){var b=[a];Ext.each(b,function(f){var c=new Array();var e=this.dataStore.get(f+"-store");if(e){for(var g=0;g<e.getCount();g++){var d=e.getAt(g);if(d.data.isDesignShow==3&&(d.data.fieldId==null||d.data.fieldId==undefined||d.data.fieldId=="")){c.push(d.data);}}if(c.length>0){this.caStore.add(f,c);}e.on("loaddataevent",this.loaddata,this);e.on("checkloadevent",this.checkdata,this);e.on("removePrimaryKey",this.removePrimaryKey,this);}},this);},removePrimaryKey:function(a){this.primarykeyRecord=null;for(var d=0;d<this.subTableKeys.length;d++){var c=this.subTableKeys[d];var e=this.dataStore.get(c+"-grid");if(e){var b=e.getStore();var f=this.findForeignKey(b,a.record.data.fieldName);if(f!=null){b.remove(f);}}}},loadFields:function(j,d){var e=this.formTables;var l=this.editGrid1;var c=l.getStore();this.caStore.clear();var m=[];for(var h=0;h<this.subTableKeys.length;h++){m.push(this.subTableKeys[h]);}this.setCacheFields("mainGrid",m);this.subTableKeys.length=0;if(e){var q=this.enHtml(j);if(q!=true){return q;}for(var h=0;h<this.subTableKeys.length;h++){var w=this.subTableKeys[h];m.remove(w);var a=this.dataStore.get(w+"-grid");if(a==null||a==undefined){var s=new Ht.DetailFormPanel({height:300,padding:"16 16 16 16",title:w+"-表",paramRoot:w,parentConf:this});var r=s.getEditGrid();if(r){this.dataStore.add(w+"-grid",r);r.on("clickPrimary",this.addPrimaryKey,this);this.dataStore.add(w+"-store",r.getStore());}this.dataStore.add(w+"-fieldset",s);this.belongTable.add(s);}}for(var k=0;k<m.length;k++){var t=m[k];var s=this.dataStore.get(t+"-fieldset");if(s){this.dataStore.removeKey(t+"-fieldset");this.dataStore.removeKey(t+"-grid");this.dataStore.removeKey(t+"-store");this.subTableKeys.remove(t);s.disable();s.hide();}}this.belongTable.doLayout(true);this.configPanel.doLayout(true);this.doLayout(true);if(e.length>0){var n,u,b,o;for(var p=0;p<e.length;p++){if(e[p].isMain==1){n=e[p];this.dataStore.add("mainTable-database",n);}else{if(!d){u=e[p];for(var h=0;h<this.subTableKeys.length;h++){if(u.tableKey==this.subTableKeys[h]){this.dataStore.add(this.subTableKeys[h]+"-database",u);}}}}}}c.fireEvent("loaddataevent",{gridKey:"mainGrid",data:this.MainTable,isMainTable:true});}return false;},setValue:function(tablePanel,preName,data){var items=tablePanel.items;if(items!=null){for(var i=0;i<items.getCount();i++){var comp=items.get(i);var xtype=comp.getXType();try{if(xtype=="hidden"||xtype=="textfield"){var name=comp.getName();if(name){if(preName){if(name.indexOf(preName)!=-1){name=name.substring(preName.length+1);}}var val=eval("data."+name);if(val!=null&&val!=undefined){comp.setValue(val);if(name.indexOf("Key")!=-1){comp.setReadOnly(true);}}}}else{if(comp.items){this.setValue(comp,preName,data);continue;}}}catch(e){}}}},validRecord:function(b,a,e,d){if(a.data.fieldType==""||a.data.fieldType==null){Ext.ux.Toast.msg("信息提示","字段数据类型不能为空！");return null;}if(a.data.fieldName==""||a.data.fieldName==null){Ext.ux.Toast.msg("信息提示","字段KEY不能为空！");return null;}for(var c=d+1;c<e;c++){var f=b.getAt(c);if(a.data.fieldName==f.data.fieldName){Ext.ux.Toast.msg("信息提示","字段KEY不能重复！");return null;}}return a;},saveRecord:function(){try{if(this.activePanel.getForm().isValid()){this.storeParam1=[];this.storeParam2=new Ext.util.MixedCollection();var o=this.editGrid1.getStore();var l=0;var s=0;var q;for(var g=0,c=o.getCount();g<c;g+=1){var b=o.getAt(g);if(b){if(b.data.isFlowTitle==1){l++;}b=this.validRecord(o,b,c,g);if(!b){return;}b=this.changeData(b);this.storeParam1.push(b.data);}if(b.data.isPrimary==1){s++;q=b.data.fieldName;}}if(o.getCount()==0){Ext.ux.Toast.msg("信息提示","主表不能没有字段！");return;}if(s==0){Ext.ux.Toast.msg("信息提示","主表缺少主键，请选择主键！");return;}if(s>1){Ext.ux.Toast.msg("信息提示","主表只能有一个主键！");return;}if(l==0){Ext.ux.Toast.msg("信息提示","必需有一个字段用于显示任务节点名称！");return;}if(l>1){Ext.ux.Toast.msg("信息提示","只能有一个字段用于显示任务节点名称！");return;}for(var g=0;g<this.subTableKeys.length;g++){var r=this.subTableKeys[g];var a=this.dataStore.get(r+"-grid");var p=a.getStore();if(!this.validStore(p,r,q)){return;}}var n=Ext.Ajax.serializeForm(this.configPanel.getForm().getEl());var k=Ext.urlDecode(n);var h=[];h.push(this.convertObj(k,"formTable",Ext.encode(this.storeParam1)));for(var d=0;d<this.subTableKeys.length;d++){var r=this.subTableKeys[d];h.push(this.convertObj(k,r,this.storeParam2.get(r+"ad")));}var f=this;this.designPanel.getForm().submit({params:{"objs":Ext.encode(h)},method:"post",waitMsg:"正在提交数据...",success:function(e,j){var i=j.result;if(!i.success){alert(i.msg);Ext.ux.Toast.msg("信息提示","已经存在相同的表名"+i.msg+"！");}else{if(f.callback){f.callback.call(f);}f.close();}},failure:function(e,j){var i=j.result;if(!i.success){Ext.ux.Toast.msg("信息提示","已经存在相同的表名"+i.msg+"！");}else{Ext.MessageBox.show({title:"操作信息",msg:"信息保存出错，请联系管理员！",buttons:Ext.MessageBox.OK,icon:"ext-mb-error"});}}});}}catch(m){alert(m);}},convertObj:function(b,c,a){var d={};d.tableId=b[c+".tableId"]?b[c+".tableId"]:null;d.tableName=b[c+".tableName"]?b[c+".tableName"]:null;d.tableKey=b[c+".tableKey"]?b[c+".tableKey"]:null;d.isMain=b[c+".isMain"]?b[c+".isMain"]:null;d.fields=a?a:null;return d;},validStore:function(h,j,k){var c=[];var g=0;var f=0;for(var d=0,b=h.getCount();d<b;d+=1){var a=h.getAt(d);if(a){a=this.validRecord(h,a,b,d);if(!a){return false;}if(a.data.foreignKey!=""&&a.data.foreignKey!=undefined){if(a.data.foreignKey!=k){Ext.ux.Toast.msg("信息提示","从表的外键所对应主表的主键不一致，请重新选择！");return false;}g++;if(a.data.foreignTable==""||a.data.foreignTable==null){Ext.ux.Toast.msg("信息提示","从表的关联表不能为空！");return false;}var l=this.configPanel.getCmpByName("formTable.tableKey").getValue();if(a.data.foreignTable!=l){Ext.ux.Toast.msg("信息提示","从表的关联表与主表名不同，请修改！");return false;}}a=this.changeData(a);c.push(a.data);}if(a.data.isPrimary==1){f++;}}if(g>1){Ext.ux.Toast.msg("信息提示","从表只能有一个外键！");return false;}if(f==0&&this.haveSub){Ext.ux.Toast.msg("信息提示","从表缺少主键，请选择主键！");return false;}if(f>1){Ext.ux.Toast.msg("信息提示","从表只能有一个主键！");return false;}if(this.haveSub){if(h.getCount()==0){Ext.ux.Toast.msg("信息提示","从表不能没有字段！");return false;}}this.storeParam2.add(j+"ad",Ext.encode(c));return true;},publishRecord:function(){this.designPanel.getCmpByName("formDef.status").setValue(1);this.saveRecord();},saveDrafRecord:function(){this.designPanel.getCmpByName("formDef.status").setValue(0);this.saveRecord();},changeData:function(a){if(a.data.isPrimary){a.set("isPrimary",1);}else{a.set("isPrimary",0);}if(a.data.isList){a.set("isList",1);}else{a.set("isList",0);}if(a.data.isQuery){a.set("isQuery",1);}else{a.set("isQuery",0);}if(a.data.isRequired){a.set("isRequired",1);}else{a.set("isRequired",0);}if(a.data.isFlowTitle){a.set("isFlowTitle",1);}else{a.set("isFlowTitle",0);}if(isNaN(a.data.fieldSize)||a.data.fieldSize==""){a.set("fieldSize",null);}if(a.data.fieldId==0){a.set("fieldId",null);}a.commit();return a;}});DesignerWin=Ext.extend(Ext.Window,{constructor:function(a){Ext.applyIf(this,a);this.initUI();DesignerWin.superclass.constructor.call(this,{title:"表单预览",iconCls:"menu-find-doc",width:800,height:430,modal:true,autoScroll:true,maximizable:true,layout:"vbox",defaults:{padding:"6"},layoutConfig:{align:"stretch"},items:[this.formPanel],buttonAlign:"center",buttons:this.buttons});},initUI:function(){this.formTable=new Ext.form.FieldSet({title:"业务表单",html:this.defHtml});this.formPanel=new Ext.FormPanel({layout:"table",border:false,frame:false,flex:1,autoScroll:true,defaults:{anchor:"98%,98%"},items:this.formTable});this.formTable.on("afterrender",this.getFormHtmlCallback,this);this.buttons=[{xtype:"button",text:"关闭",iconCls:"btn-close",scope:this,handler:function(){try{if(this.officePanel){this.officePanel.closeDoc();}}catch(a){}this.close();}}];},getFormHtmlCallback:function(){try{$ImportSimpleJs([__ctxPath+"/js/core/ntkoffice/NtkOfficePanel.js",__ctxPath+"/js/selector/SealSelector.js",__ctxPath+"/js/selector/PaintTemplateSelector.js"],function(){$converDetail.call(this,null,null);},this);}catch(a){alert(a);}}});Ext.ns("Ext.ux.dd");Ext.ux.dd.GridDragZone=function(b,a){this.view=b.getView();Ext.ux.dd.GridDragZone.superclass.constructor.call(this,this.view.mainBody.dom,a);this.scroll=false;this.grid=b;this.ddel=document.createElement("div");this.ddel.className="x-grid-dd-wrap";};Ext.extend(Ext.ux.dd.GridDragZone,Ext.dd.DragZone,{getDragData:function(b){var d=this.grid.selModel;var a=Ext.lib.Event.getTarget(b);var c=this.view.findRowIndex(a);if(c!==false){if(!d.isSelected(c)||b.hasModifier()){d.handleMouseDown(this.grid,c,b);}}if(d.getSelections().length>0){return{grid:this.grid,ddel:this.ddel,selections:d.getSelections()};}return false;},onInitDrag:function(b){var a=this.dragData;this.ddel.innerHTML=this.grid.getDragDropText();this.proxy.update(this.ddel);},getRepairXY:function(){return this.dragData.repairXY;}});Ext.ux.dd.GridDropZone=function(b,a){this.view=b.getView();Ext.ux.dd.GridDropZone.superclass.constructor.call(this,this.view.scroller,a);this.scroll=false;this.grid=b;};Ext.extend(Ext.ux.dd.GridDropZone,Ext.dd.DropZone,{getTargetFromEvent:function(a){return this.view.scroller;},onNodeEnter:function(d,a,c,b){Ext.fly(d).addClass("my-row-highlight-class");},onNodeOut:function(d,a,c,b){Ext.fly(d).removeClass("my-row-highlight-class");},onNodeOver:function(d,a,c,b){return Ext.dd.DropZone.prototype.dropAllowed;},onNodeDrop:function(h,m,j,f){var a=f.grid;var b=this.grid;var c=f.selections;var l=a.getStore();for(var d=0;d<c.length;d++){l.remove(c[d]);}a.getView().refresh();var k=this.grid.getStore();var g=k.getCount();k.insert(g,c);this.grid.getView().refresh();return true;}});