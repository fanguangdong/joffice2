FlowDesignerWindow=Ext.extend(Ext.Window,{constructor:function(b){Ext.applyIf(this,b);var c='<APPLET codebase="." id="flowDesigner" ARCHIVE="'+__ctxPath+'/js/flowDesign/workflow.jar" '+'code="com.htsoft.jbpm.designer.ProcessApplet.class"  width="100%" height="100%"></APPLET>';this.leftPanel=new Ext.Panel({region:"center",border:false,layout:"fit",html:c});Ext.useShims=true;this.leftPanel.on("afterrender",function(d){this.deisigner=document.getElementById("flowDesigner");},this);this.formPanel=new Ext.FormPanel({width:260,layout:"anchor",region:"east",bodyStyle:"margin:6px 0px 0px 0px;background-color:#DFE8F6",defaults:{anchor:"100%"},items:[{name:"proDefinition.defId",id:"defId",xtype:"hidden",value:this.defId==null?"":this.defId},{xtype:"hidden",id:"proTypeId",name:"proDefinition.proTypeId"},{text:"流程分类",xtype:"label"},new TreeSelector("proTypeTreeSelector",__ctxPath+"/system/flowTreeGlobalType.do?catKey=FLOW","流程分类","proTypeId",true),{text:"流程的名称",xtype:"label"},{name:"proDefinition.name",xtype:"textfield",allowBlank:false,id:"name"},{text:"JBPM流程Key",xtype:"label"},{name:"proDefinition.processName",xtype:"textfield",allowBlank:false,id:"processName"},{text:"流程状态",xtype:"label"},{hiddenName:"proDefinition.status",xtype:"combo",allowBlank:false,editable:false,mode:"local",triggerAction:"all",store:[["0","禁用"],["1","激活"]],value:1},{text:"描述",xtype:"label"},{xtype:"textarea",height:200,name:"proDefinition.description",id:"description"},{xtype:"hidden",height:200,name:"proDefinition.drawDefXml",id:"drawDefXml"}]});FlowDesignerWindow.superclass.constructor.call(this,{id:"flowDesignerWindow",title:"在线流程设计",iconCls:"btn-flow-design",defaults:{border:false},layout:"border",height:560,width:860,modal:true,maximizable:true,closeAction:"close",items:[this.leftPanel,this.formPanel],buttonAlign:"center",buttons:[{text:"保存",scope:this,iconCls:"btn-save",handler:this.save},{text:"发布",scope:this,iconCls:"btn-save",handler:this.deploy},{text:"取消",scope:this,iconCls:"btn-cancel",handler:this.close}]});function a(g){try{var d=document.applets.flowDesigner;d.setData(g);}catch(f){setTimeout(function(){a(g);},1000);}}if(this.defId!=null&&this.defId!="undefined"&&this.defId!=""){this.formPanel.loadData({url:__ctxPath+"/flow/getProDefinition.do?defId="+this.defId,root:"data",preName:"proDefinition",scope:this,success:function(e,g){var d=Ext.util.JSON.decode(e.responseText);if(d){var f=d.data.proType;if(f!=null){this.formPanel.getCmpByName("proTypeTreeSelector").setValue(f.typeName);this.formPanel.getCmpByName("proDefinition.proTypeId").setValue(f.proTypeId);}var h=d.data.drawDefXml;a(h);}}});}},save:function(){this.onSave.call(this,false);},deploy:function(){this.onSave.call(this,true);},onSave:function(a){document.getElementById("drawDefXml").value=document.applets.flowDesigner.getData();if(this.formPanel.getForm().isValid()){this.formPanel.getForm().submit({url:__ctxPath+"/flow/defSaveProDefinition.do",method:"POST",waitMsg:"正在提交数据...",params:{deploy:a},success:function(b,e){var d=Ext.getCmp("ProDefinitionGrid");if(d!=null){d.getStore().reload();}var c=Ext.getCmp("ProDefinitionGrid0");if(c!=null){c.getStore().reload();}Ext.getCmp("flowDesignerWindow").close();},failure:function(b,d){var c=d.result.msg;if(c){Ext.MessageBox.show({title:"操作信息",msg:c,buttons:Ext.MessageBox.OK,icon:"ext-mb-error"});}else{Ext.MessageBox.show({title:"操作信息",msg:"信息保存出错，请联系管理员！",buttons:Ext.MessageBox.OK,icon:"ext-mb-error"});}}});}}});