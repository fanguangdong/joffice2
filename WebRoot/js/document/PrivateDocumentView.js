PrivateDocumentView=Ext.extend(Ext.Panel,{searchPanel:null,showPanel:null,store:null,dataView:null,selectNode:null,constructor:function(a){Ext.applyIf(this,a);this.initUI();PrivateDocumentView.superclass.constructor.call(this,{title:"我的文档",iconCls:"menu-personal-doc",layout:"border",region:"center",id:"PrivateDocumentView",height:800,width:800,items:[this.treePanel,{region:"center",layout:"border",items:[this.searchPanel,this.showPanel]}]});},initUI:function(){this.searchPanel=new Ext.FormPanel({height:35,region:"north",frame:false,border:false,layout:"hbox",layoutConfig:{padding:"5",align:"middle"},defaults:{style:"padding:0px 5px 0px 5px;",border:false,anchor:"98%,98%",labelWidth:75,xtype:"label"},items:[{text:"文件名："},{xtype:"textfield",name:"fileName"},{xtype:"button",text:"查询",scope:this,iconCls:"btn-search",handler:this.search},{xtype:"button",text:"重置",scope:this,iconCls:"btn-reset",handler:function(){this.searchPanel.getForm().reset();}}]});this.store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:__ctxPath+"/document/folderDocFolder.do"}),reader:new Ext.data.JsonReader({root:"result",id:"id",fields:["fileId","fileName","fileSize","fileType","isFolder",{name:"parentId",type:"int"},"parentName","isShared"]}),remoteSort:true});this.store.setDefaultSort("isFolder","desc");this.store.load();this.dataView=new Ext.DataView({region:"center",border:false,store:this.store,tpl:new Ext.XTemplate("<ul>",'<tpl for=".">','<li class="phone" id="{fileId}" name="{fileName}" type="{isFolder}" ext:qtip="<div>{fileName}</div><div>{fileType}</div>" onselect= "document.selection.empty()">','<img width="64" height="64" src="'+__ctxPath+'/images/flag/document/{[(values.isFolder==0?(values.isShared==0?"file.png":"share.png"):"folder.png")]}" />','<strong style="font-size:15px;overflow:hidden;">{fileName}</strong>',"</li>","</tpl>","</ul>"),id:"phones",itemSelector:"li.phone",overClass:"phone-hover",multiSelect:true,autoScroll:true,listeners:{"render":{fn:this.bodyRender,scope:this},"dblclick":{fn:this.openFile,scope:this},"contextmenu":{fn:this.dbclickNode,scope:this}}});this.toolbar=new Ext.Toolbar({items:[{xtype:"button",text:"新建文件夹",scope:this,iconCls:"btn-add",id:"NewPrivateFolderButton",handler:this.newFolder},{xtype:"button",text:"新建文档",scope:this,id:"NewPrivateDocumentButton",iconCls:"btn-add",handler:this.newDocument},{xtype:"button",text:"向上",iconCls:"btn-up",id:"UpPrivateFolderButton",scope:this,handler:this.upLevel},{xtype:"button",text:"刷新",iconCls:"btn-refresh",scope:this,handler:this.refresh}]});this.treePanel=new Ext.tree.TreePanel({region:"west",title:"目录",collapsible:true,split:true,autoScroll:true,width:200,height:800,animate:true,enableDD:true,tbar:new Ext.Toolbar({items:[{xtype:"button",iconCls:"btn-refresh",text:"刷新",scope:this,handler:function(){this.treePanel.root.reload();}},{xtype:"button",text:"展开",scope:this,iconCls:"btn-expand",handler:function(){this.treePanel.expandAll();}},{xtype:"button",text:"收起",scope:this,iconCls:"btn-collapse",handler:function(){this.treePanel.collapseAll();}}]}),loader:new Ext.tree.TreeLoader({url:__ctxPath+"/document/listDocFolder.do",listeners:{scope:this,"load":function(){if(!this.selectNode){this.selectNode=this.treePanel.getNodeById(0);this.selectNode.select();}else{this.selectNodeMethod(this.selectNode);}this.changePath();}}}),root:new Ext.tree.AsyncTreeNode({expanded:true,draggable:true}),rootVisible:false,listeners:{scope:this,"click":this.clickNode,"contextmenu":this.treeContextMenu,"beforemovenode":this.moveNode}});this.showPanel=new Ext.Panel({region:"center",tbar:this.toolbar,layout:"border",items:[{xtype:"panel",height:28,region:"north",layout:"fit",items:[{xtype:"textfield",readOnly:true,style:"padding-left:15px;",cls:"text-file",name:"FilePathDisplayField",id:"FilePathDisplayField",value:"/我的文件夹"}]},this.dataView]});},treeContextMenu:function(b,d){this.clickNode(b);var a=new Array();a.push({text:"新建",scope:this,iconCls:"btn-add",handler:this.newFolder});if(b.id!=0){a.push({text:"修改",scope:this,iconCls:"btn-edit",handler:this.editFile.createCallback(this,true)});a.push({text:"删除",scope:this,iconCls:"btn-delete",handler:this.delFolder.createCallback(this,this.dataView,this.selectNode.id,this.treePanel,true)});}a.push({text:"属性",scope:this,iconCls:"btn-detail",handler:this.folderDetail});var c=new Ext.menu.Menu({items:a});c.showAt(d.getXY());},newDocument:function(){if(this.selectNode&&this.selectNode.id!=0){new DocumentForm({folderId:this.selectNode.id,folderName:this.selectNode.text}).show();}else{new DocumentForm().show();}},moveNode:function(a,f,d,e,c){if(d.id==e.id){return false;}var g=this.dataView;var b=this;Ext.Msg.confirm("操作提示","你确定移动该目录吗?",function(h){if(h=="yes"){Ext.Ajax.request({url:__ctxPath+"/document/moveDocFolder.do",params:{folderIdOld:f.id,folderIdNew:e.id},method:"post",success:function(i,j){a.root.reload();g.getStore().reload();},failure:function(i,j){}});return;}});return false;},refresh:function(){var a=this.dataView.getStore();this.treePanel.root.reload();a.reload();},folderDetail:function(){if(!this.selectNode){return;}new FileDetailShowWin({isPersonal:true,fileId:this.selectNode.id,isFolder:true}).show();},bodyRender:function(a){a.getEl().on("contextmenu",this.bodyContextClick,this);},bodyContextClick:function(f,b,g){var d=b;if(d.id!="phones"){return;}var a=new Array();a.push({text:"上一目录",scope:this,disabled:this.isSearching?true:false,iconCls:"btn-up",handler:this.upLevel});a.push({text:"新建文件",scope:this,iconCls:"btn-add",disabled:this.isSearching?true:false,handler:this.newFolder});a.push({text:"新建文档",scope:this,iconCls:"btn-add",disabled:this.isSearching?true:false,handler:this.newDocument});a.push({text:"刷新",scope:this,iconCls:"btn-refresh",handler:this.refresh});a.push({text:"属性",scope:this,iconCls:"btn-detail",disabled:this.isSearching?true:false,handler:this.folderDetail});var c=new Ext.menu.Menu({items:a});c.showAt(f.getXY());},search:function(){this.isSearching=true;this.searchDisable();var a=this.searchPanel;if(a.getForm().isValid()){var c=Ext.Ajax.serializeForm(a.getForm().getEl());var b=Ext.urlDecode(c);b.isSearch=true;b.limit=10000;this.store.baseParams=b;this.store.reload();}},searchDisable:function(){Ext.getCmp("NewPrivateFolderButton").disable();Ext.getCmp("NewPrivateDocumentButton").disable();Ext.getCmp("UpPrivateFolderButton").disable();this.isSearching=true;},searchEnable:function(){Ext.getCmp("NewPrivateFolderButton").enable();Ext.getCmp("NewPrivateDocumentButton").enable();Ext.getCmp("UpPrivateFolderButton").enable();this.isSearching=false;},changePath:function(){var a=this.selectNode;var b="";while(a!=null&&a.text!=undefined){b="/"+a.text+b;a=a.parentNode;}Ext.getCmp("FilePathDisplayField").setValue(b);},newFolder:function(){var c=0;var b=this.selectNode;if(b){c=this.selectNode.id;}var a=this.treePanel;new DocFolderForm({folderId:null,parentId:c,isShared:null,callback:function(){a.root.reload();}}).show();},upLevel:function(){this.isSearching=false;var c=this.selectNode;var a=c.parentNode;if(c&&c.id==0){Ext.ux.Toast.msg("提示信息","已是最顶层!");return;}var b=this.dataView.getStore();b.baseParams.isSearch=false;b.reload({params:{folderId:a.id}});this.selectNode=a;this.selectNodeMethod(a);},selectNodeMethod:function(){if(this.selectNode){this.selectNode=this.treePanel.getNodeById(this.selectNode.id);this.selectNode.select();}},dbclickNode:function(h,i,d,j){h.all.each(function(e){h.deselect(e);});h.select(i,true);var g=this.treePanel;var b=h.getSelectedNodes();if(b!=""&&b!=null&&b!="undefined"){var a=new Array();var k=b[0].type;var c=b[0].id;a.push({text:"打开",scope:this,iconCls:"btn-add",handler:this.openFile});if(k==1){a.push({text:"修改",scope:this,iconCls:"btn-edit",handler:this.editFile.createCallback(this)});a.push({text:"删除",scope:this,iconCls:"btn-delete",handler:this.delFolder.createCallback(this,h,c,g,false)});}else{a.push({text:"共享",scope:this,iconCls:"btn-shared",handler:this.shareDocument});a.push({text:"删除",scope:this,iconCls:"btn-delete",handler:this.delDocument.createCallback(h,c)});}a.push({text:"属性",scope:this,iconCls:"btn-detail",handler:this.fileDetail});var f=new Ext.menu.Menu({items:a});f.showAt(j.getXY());}},cutFile:function(){this.cuting=true;},moveFile:function(){this.cuting=false;},fileDetail:function(){var a=this.dataView;var b=a.getSelectedNodes();var e=b[0];var f=Ext.getCmp("FilePathDisplayField");var d=b[0].type;var c=false;if(d==1){c=true;}new FileDetailShowWin({isPersonal:true,fileId:e.id,filePath:f.getValue(),isFolder:c}).show();},openFile:function(){var a=this.dataView;var c=a.getSelectedNodes();if(c[0].type==1){var b=a.getStore();b.baseParams.isSearch=false;b.reload({params:{folderId:c[0].id}});var d=this.treePanel.getNodeById(c[0].id);d.select();this.selectNode=d;this.changePath();this.searchEnable();}else{new DocumentForm({docId:c[0].id}).show();}},clickNode:function(c){this.selectNode=c;this.changePath();var a=this.dataView;var b=a.getStore();b.baseParams.isSearch=false;b.reload({params:{folderId:c.id}});this.searchEnable();},editFile:function(d,f){var b=d.dataView;var c=b.getSelectedNodes();if((c[0]&&c[0].type==1)||f==true){var e=d.treePanel;var a;if(f){a=d.selectNode.id;}else{a=c[0].id;}new DocFolderForm({folderId:a,parentId:null,isShared:null,callback:function(){e.root.reload();}}).show();}else{new DocumentForm({docId:c[0].id}).show();}},shareDocument:function(){var a=this.dataView;var b=a.getSelectedNodes();if(b[0].type!=1){new DocumentSharedForm({docId:b[0].id}).show();}},delFolder:function(c,b,a,d,f){var e=c.selectNode;Ext.Msg.confirm("删除操作","你确定删除该目录吗?",function(g){if(g=="yes"){Ext.Ajax.request({url:__ctxPath+"/document/removeDocFolder.do",params:{folderId:a},method:"post",success:function(h,j){var i=Ext.util.JSON.decode(h.responseText);if(i.success==false){Ext.ux.Toast.msg("操作信息",i.message);}else{d.root.reload();if(f&&e.parentNode){c.clickNode(e.parentNode);}else{c.clickNode(e);}Ext.ux.Toast.msg("操作信息","成功删除目录！");}},failure:function(h,i){Ext.MessageBox.show({title:"操作信息",msg:"信息保存出错，请联系管理员！",buttons:Ext.MessageBox.OK,icon:"ext-mb-error"});}});}});},delDocument:function(b,a){Ext.Msg.confirm("信息确认","您确认要删除该文档吗？",function(c){if(c=="yes"){Ext.Ajax.request({url:__ctxPath+"/document/multiDelDocument.do",params:{ids:a},method:"post",success:function(){b.getStore().reload({params:{}});Ext.ux.Toast.msg("信息提示","成功删除所选文档！");}});}});}});