Ext.ns("OnlineDocumentManageView");OnlineDocumentManageView=Ext.extend(Ext.Panel,{searchFormPanel:null,showPanel:null,gridPanel:null,treePanel:null,fileId:0,fileName:null,store:null,selectNode:null,isSearching:false,constructor:function(a){Ext.applyIf(this,a);this.initUI();OnlineDocumentManageView.superclass.constructor.call(this,{id:"OnlineDocumentManageView",layout:"border",title:"在线文档管理",iconCls:"menu-onlinedoc",region:"center",items:[this.showPanel]});},initUI:function(){this.searchFormPanel=new Ext.FormPanel({height:35,region:"north",frame:false,border:false,layout:"hbox",layoutConfig:{padding:"5",align:"middle"},defaults:{style:"padding:0px 5px 0px 5px;",border:false,anchor:"98%,98%",labelWidth:75,xtype:"label"},items:[{text:"文件名："},{xtype:"textfield",name:"fileName"},{xtype:"button",text:"查询",scope:this,iconCls:"btn-search",handler:this.search},{xtype:"button",text:"重置",scope:this,iconCls:"btn-reset",handler:function(){this.searchFormPanel.getForm().reset();}}]});this.treePanel=new Ext.tree.TreePanel({region:"west",id:"OnlineTreePanel",title:"知识目录",collapsible:true,split:true,autoScroll:true,width:200,height:800,tbar:new Ext.Toolbar({items:[{xtype:"button",iconCls:"btn-refresh",text:"刷新",scope:this,handler:function(){this.treePanel.root.reload();}},{xtype:"button",text:"展开",scope:this,iconCls:"btn-expand",handler:function(){this.treePanel.expandAll();}},{xtype:"button",text:"收起",scope:this,iconCls:"btn-collapse",handler:function(){this.treePanel.collapseAll();}}]}),loader:new Ext.tree.TreeLoader({url:__ctxPath+"/document/onlineTreeDocFolder.do",listeners:{scope:this,"load":function(){this.store.load({folderId:0});}}}),root:new Ext.tree.AsyncTreeNode({expanded:true}),rootVisible:false,listeners:{scope:this,"click":this.clickNode,"contextmenu":this.treeContextMenu}});var b=new Ext.grid.CheckboxSelectionModel();var a=new Ext.grid.ColumnModel({columns:[new Ext.grid.RowNumberer(),{header:"fileId",dataIndex:"fileId",hidden:true},{header:"文件名",dataIndex:"fileName",width:120,renderer:function(f,e,c){var d=c.data.isFolder;var g=c.data.fileType;if(d==1){return'<img width="16" height="16" src="'+__ctxPath+'/images/flag/document/folder.png"/>'+f+"</img>";}else{return'<img width="16" height="16" src="'+__ctxPath+"/images/flag/document/"+g+'.png"/>'+f+"."+g+"</img>";}}},{header:"类型",dataIndex:"fileType",width:60},{header:"文件大小",dataIndex:"fileSize",renderer:function(c){return'<span ext:qtip="文件大小：'+c+'">'+c+"</span>";}},{header:"作者",dataIndex:"author",width:80},{header:"更新时间",dataIndex:"updateTime"},{header:"管理",dataIndex:"docId",width:120,renderer:function(l,i,e,h,m){var d=e.data.fileId;var j=e.data.isFolder;var f=e.data.rightMod;var k=e.data.rightDel;var c=e.data.fileName;var n=e.data.fileType;var g='<a title="属性" value="" href="#" onclick="OnlineDocumentManageView.pro('+d+","+j+')">属性</a>';if(f==1&&j==0){g+='<a title="编辑" value="" class="" href="#" onclick="OnlineDocumentManageView.edit('+d+","+j+",'"+n+"')\">&nbsp;编辑</a>";}if(k==1&&j==0){g+='<a title="删除" value="" class="" href="#" onclick="OnlineDocumentManageView.deleteDocument('+d+')">&nbsp;删除</a>';}if(j==1){g+='<a title="编辑" value="" class="" href="#" onclick="OnlineDocumentManageView.edit('+d+","+j+')">&nbsp;编辑</a>';g+='<a title="删除" value="" class="" href="#" onclick="OnlineDocumentManageView.deleteFolder('+d+')">&nbsp;删除</a>';g+='<a title="授权" value="" class="" href="#" onclick="OnlineDocumentManageView.privilege('+d+",'"+c+"')\">&nbsp;授权</a>";}if(j==0){g+='<a title="查看" value="" class="" href="#" onclick="OnlineDocumentManageView.detail('+d+')">&nbsp;查看</a>';}return g;}}],defaults:{menuDisabled:true,width:100}});this.store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:__ctxPath+"/document/onlineListDocFolder.do"}),reader:new Ext.data.JsonReader({root:"result",id:"id",fields:["fileId","fileName","fileSize","fileType","isFolder",{name:"parentId",type:"int"},"parentName","isShared","rightRead","rightMod","rightDel","author","keywords","updateTime"]}),remoteSort:true,listeners:{scope:this,"load":this.loadAction}});this.toolbar=new Ext.Toolbar({border:false,items:[{xtype:"button",text:"新建文件夹",scope:this,iconCls:"btn-add",id:"newOnlineFolderButton",handler:this.newFolder},{xtype:"button",text:"新建DOC文档",id:"newOnlineDocumentButton",scope:this,iconCls:"btn-add",handler:function(){if(this.fileId!=0&&this.fileName!=""){new OnlineDocumentForm({docType:"doc",folderId:this.fileId,folderName:this.fileName}).show();}else{new OnlineDocumentForm({docType:"doc"}).show();}}},{xtype:"button",text:"新建EXL文档",id:"newOnlineEXCELButton",scope:this,iconCls:"btn-add",handler:function(){if(this.fileId!=0&&this.fileName!=""){new OnlineDocumentForm({docType:"xls",folderId:this.fileId,folderName:this.fileName}).show();}else{new OnlineDocumentForm({docType:"xls"}).show();}}},{xtype:"button",text:"新建PPT文档",id:"newOnlinePPTButton",scope:this,iconCls:"btn-add",handler:function(){if(this.fileId!=0&&this.fileName!=""){new OnlineDocumentForm({docType:"ppt",folderId:this.fileId,folderName:this.fileName}).show();}else{new OnlineDocumentForm({docType:"ppt"}).show();}}},{xtype:"button",text:"上一层",id:"upOnlineLevelButton",iconCls:"btn-up",scope:this,handler:this.upLevel},{xtype:"button",text:"目录",iconCls:"btn-up",scope:this,handler:this.firstLevel},{xtype:"button",text:"刷新",iconCls:"btn-refresh",id:"refreshOnlineButton",scope:this,handler:function(){this.store.reload();this.selectNode=this.treePanel.getNodeById(this.fileId);this.selectNode.select();this.changPath();}}]});this.gridPanel=new Ext.grid.GridPanel({region:"center",tbar:this.toolbar,id:"OnlineDocumentGrid",store:this.store,trackMouseOver:true,disableSelection:false,loadMask:true,cm:a,sm:b,viewConfig:{forceFit:true,enableRowBody:false,showPreview:false}});this.gridPanel.addListener("rowdblclick",function(d,c,f){d.getSelectionModel().each(function(g){if(g.data.isFolder==1){this.fileId=g.data.fileId;this.fileName=g.data.fileName;var e=d.getStore();e.baseParams={folderId:g.data.fileId};e.reload();this.getTitle().setTitle("["+g.data.fileName+"]在线文档列表");this.selectNode=this.treePanel.getNodeById(this.fileId);this.selectNode.select();this.changPath();this.searchEnable();}else{new OnlineDocumentDetail({docId:g.data.fileId,docType:g.data.fileType}).show();}},this);},this);this.showPanel=new Ext.Panel({region:"center",border:false,layout:"border",items:[this.treePanel,{layout:"border",border:false,region:"center",items:[{xtype:"panel",height:28,region:"north",layout:"fit",items:[{xtype:"textfield",readOnly:true,style:"padding-left:15px;",cls:"text-file",name:"FilePathDisplayField",id:"OnlineDocumentPathDisplayField",value:"/在线文档目录"}]},{layout:"border",id:"TitleOnlineShowPanel",region:"center",title:"在线文档列表",border:false,items:[this.searchFormPanel,this.gridPanel]}]}]});},treeContextMenu:function(b,d){this.clickNode(b);var a=new Array();a.push({text:"新建",scope:this,iconCls:"btn-add",handler:this.newFolder});if(b.id!=0){a.push({text:"修改",scope:this,iconCls:"btn-edit",handler:this.editFolder});a.push({text:"删除",scope:this,iconCls:"btn-delete",handler:this.delFolder});a.push({text:"属性",scope:this,iconCls:"btn-detail",handler:this.proFolder});}var c=new Ext.menu.Menu({items:a});c.showAt(d.getXY());},search:function(){this.isSearching=true;this.searchDisable();var a=this.searchFormPanel;if(a.getForm().isValid()){var c=Ext.Ajax.serializeForm(a.getForm().getEl());var b=Ext.urlDecode(c);b.isSearch=true;this.store.baseParams=b;this.store.reload();}},searchDisable:function(){Ext.getCmp("upOnlineLevelButton").disable();Ext.getCmp("newOnlineFolderButton").disable();Ext.getCmp("newOnlineDocumentButton").disable();Ext.getCmp("newOnlineEXCELButton").disable();Ext.getCmp("newOnlinePPTButton").disable();Ext.getCmp("refreshOnlineButton").disable();this.treePanel.getNodeById(0).select();Ext.getCmp("OnlineDocumentPathDisplayField").setValue("/在线文档目录");},searchEnable:function(){this.isSearching=false;Ext.getCmp("upOnlineLevelButton").enable();Ext.getCmp("newOnlineFolderButton").enable();Ext.getCmp("newOnlineDocumentButton").enable();Ext.getCmp("newOnlineEXCELButton").enable();Ext.getCmp("newOnlinePPTButton").enable();Ext.getCmp("refreshOnlineButton").enable();},newFolder:function(){var a=this.treePanel;new DocFolderForm({folderId:null,parentId:this.fileId,isShared:2,callback:function(){a.root.reload();}}).show();},editFolder:function(){var a=this.treePanel;new DocFolderForm({folderId:this.fileId,callback:function(){a.root.reload();}}).show();},delFolder:function(){var d=this.treePanel;var a=this.fileId;var b=this;var c=this.selectNode.parentNode;Ext.Msg.confirm("删除操作","你确定删除该目录吗?",function(e){if(e=="yes"){Ext.Ajax.request({url:__ctxPath+"/document/removeDocFolder.do",params:{folderId:a},method:"post",success:function(f,h){var g=Ext.util.JSON.decode(f.responseText);if(g.success==false){Ext.ux.Toast.msg("操作信息",g.message);}else{Ext.ux.Toast.msg("操作信息","成功删除目录！");d.root.reload();b.clickNode(c);}},failure:function(f,g){Ext.MessageBox.show({title:"操作信息",msg:"信息保存出错，请联系管理员！",buttons:Ext.MessageBox.OK,icon:"ext-mb-error"});}});}});},getTitle:function(){var a=Ext.getCmp("TitleOnlineShowPanel");if(a!=null){return a;}return null;},loadAction:function(c){if(!this.isSearching){var b=c.getAt(0);if(b!=null){var d=b.get("isFolder");if(d==1){var f=b.get("parentId");var e=b.get("parentName");if(f==0){this.getTitle().setTitle("在线文档列表");}else{this.fileName=e;this.getTitle().setTitle("["+e+"]在线文档列表");}this.fileId=f;}}var a=this.treePanel.getNodeById(this.fileId);if(a){this.selectNode=a;this.selectNode.select();this.changPath();if(a.id==0){this.getTitle().setTitle("在线文档列表");}else{this.fileId=a.id;this.fileName=a.text;this.getTitle().setTitle("["+a.text+"]在线文档列表");}}}else{this.getTitle().setTitle("查询结果列表");}},clickNode:function(b){if(b!=null){this.selectNode=b;this.changPath();var c=this.gridPanel;if(b.id==0){this.getTitle().setTitle("在线文档列表");}else{this.fileName=b.text;this.getTitle().setTitle("["+b.text+"]在线文档列表");}this.fileId=b.id;var a=c.getStore();a.baseParams={folderId:b.id};a.reload();this.searchEnable();}},changPath:function(){var a=this.selectNode;var b="";while(a!=null&&a.text!=undefined){b="/"+a.text+b;a=a.parentNode;}Ext.getCmp("OnlineDocumentPathDisplayField").setValue(b);},upLevel:function(){if(this.fileId==0||this.fileId==null){Ext.ux.Toast.msg("提示信息","已是最顶层!");return;}this.store.baseParams={folderId:this.fileId,isUp:true};this.store.reload();},firstLevel:function(){this.store.baseParams={folderId:0};this.store.reload();this.getTitle().setTitle("在线文档列表");this.searchEnable();}});OnlineDocumentManageView.pro=function(a,b){var c=Ext.getCmp("OnlineDocumentPathDisplayField").getValue();if(b==1){new FileDetailShowWin({isOnline:true,fileId:a,filePath:c,isFolder:true}).show();}else{new FileDetailShowWin({isOnline:true,fileId:a,filePath:c,isFolder:false}).show();}};OnlineDocumentManageView.edit=function(b,c,a){if(c==1){var d=Ext.getCmp("OnlineTreePanel");new DocFolderForm({folderId:b,callback:function(){d.root.reload();}}).show();}else{new OnlineDocumentForm({docId:b,docType:a}).show();}};OnlineDocumentManageView.detail=function(a){new OnlineDocumentDetail({docId:a}).show();};OnlineDocumentManageView.privilege=function(a,b){new KnowledgePrivilegeWin({folderId:a,folderName:b}).show();};OnlineDocumentManageView.deleteFolder=function(a){Ext.Msg.confirm("删除操作","你确定删除该目录吗?",function(b){if(b=="yes"){Ext.Ajax.request({url:__ctxPath+"/document/removeDocFolder.do",params:{folderId:a},method:"post",success:function(c,f){var d=Ext.util.JSON.decode(c.responseText);if(d.success==false){Ext.ux.Toast.msg("操作信息",d.message);}else{Ext.ux.Toast.msg("操作信息","成功删除目录！");var e=Ext.getCmp("OnlineTreePanel");e.root.reload();}},failure:function(c,d){Ext.MessageBox.show({title:"操作信息",msg:"信息保存出错，请联系管理员！",buttons:Ext.MessageBox.OK,icon:"ext-mb-error"});}});}});};OnlineDocumentManageView.deleteDocument=function(a){Ext.Msg.confirm("信息确认","您确认要删除该文档吗？",function(b){if(b=="yes"){Ext.Ajax.request({url:__ctxPath+"/document/multiDelDocument.do",params:{ids:a},method:"post",success:function(){var c=Ext.getCmp("OnlineDocumentGrid");c.getStore().reload();}});}});};