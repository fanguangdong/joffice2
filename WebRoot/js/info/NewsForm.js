NewsForm=Ext.extend(Ext.Window,{imagePanlbar:null,constructor:function(a){Ext.applyIf(this,a);this.initUIComponents();NewsForm.superclass.constructor.call(this,{id:"NewsFormWin",layout:"fit",items:this.formPanel,modal:true,height:550,width:1030,maximizable:true,iconCls:"menu-news",title:"新闻详细新闻",buttonAlign:"center",buttons:[{text:"保存",iconCls:"btn-save",scope:this,handler:this.save},{text:"重置",iconCls:"btn-reset",scope:this,handler:this.reset},{text:"取消",iconCls:"btn-cancel",scope:this,handler:this.cancel}]});},initUIComponents:function(){this.imagePanlbar=new Ext.Toolbar({items:[{iconCls:"btn-upload",text:"上传",scope:this,handler:this.uploadImage.createCallback(this)},{iconCls:"btn-del",text:"删除",scope:this,handler:function(){}}]});this.formPanel=new Ext.FormPanel({layout:"hbox",frame:false,layoutConfig:{padding:"5",pack:"start",align:"middle"},defaults:{margins:"0 5 0 0"},border:false,items:[{xtype:"fieldset",title:"新闻内容",layout:"form",flex:2,labelWidth:60,width:"60%",defaultType:"textfield",autoHeight:true,defaults:{width:"97%"},items:[{name:"news.newsId",xtype:"hidden",value:this.newsId==null?"":this.newsId},{name:"news.sectionId",xtype:"hidden"},{fieldLabel:"是否新闻",name:"news.isNotice",xtype:"hidden",value:0},{xtype:"compositefield",fieldLabel:"所属栏目",items:[{xtype:"textfield",name:"sectionName",allowBlank:false,readOnly:true},{xtype:"button",text:"选择栏目",iconCls:"btn-select",scope:this,handler:this.section.createCallback(this)}]},{fieldLabel:"新闻标题",name:"news.subject",allowBlank:false,maxLength:128},{fieldLabel:"作者",name:"news.author",allowBlank:false,maxLength:32},{fieldLabel:"内容",name:"news.content",allowBlank:false,height:360,xtype:"fckeditor",maxLength:65535}]},{xtype:"fieldset",title:"其他新闻",flex:1,layout:"form",labelWidth:60,defaultType:"textfield",width:"34%",autoHeight:true,defaults:{width:"97%"},items:[{fieldLabel:"新闻图片",name:"news.subjectIcon",maxLength:128,xtype:"hidden"},{fieldLabel:"创建时间",name:"news.createtime",allowBlank:false,xtype:"datefield",format:"Y-m-d",value:new Date()},{fieldLabel:"发布人",name:"news.issuer",allowBlank:false,maxLength:32,value:curUserInfo.fullname},{fieldLabel:"状态",hiddenName:"news.status",allowBlank:false,xtype:"combo",editable:false,mode:"local",triggerAction:"all",store:[["0","禁用"],["1","激活"]],value:1},{fieldLabel:"顺序",name:"news.sn",xtype:"numberfield"},{xtype:"panel",title:"图片",name:"NewsImageScanPanel",height:337,width:345,tbar:this.imagePanlbar,html:'<img style="border:0;"  src="'+__ctxPath+'/images/default_newsIcon.jpg" border="0"/>'}]}]});if(this.newsId!=null&&this.newsId!="undefined"){var a=this.formPanel;a.loadData({url:__ctxPath+"/info/getNews.do?newsId="+this.newsId,root:"data",preName:"news",success:function(b,c){var d=Ext.util.JSON.decode(b.responseText).data;a.getCmpByName("sectionName").setValue(d.section.sectionName);a.getCmpByName("news.createtime").setValue(new Date(getDateFromFormat(d.createtime,"yyyy-MM-dd HH:mm:ss")));var e=a.getCmpByName("NewsImageScanPanel");if(d.subjectIcon!=""){e.body.update('<img style="border:0;" src="'+__ctxPath+"/attachFiles/"+d.subjectIcon+'" border="0"/>');}},failure:function(b,c){Ext.ux.Toast.msg("编辑","载入失败");}});}},reset:function(){this.formPanel.getForm().reset();},cancel:function(){this.close();},save:function(){$postForm({formPanel:this.formPanel,scope:this,url:__ctxPath+"/info/saveNews.do",callback:function(a,c){var b=Ext.getCmp("NewsGrid");if(b!=null){b.getStore().reload();}this.close();}});},uploadImage:function(b){var f=b.getCmpByName("NewsImageScanPanel");var c=b.getCmpByName("news.subjectIcon");var a=b.getCmpByName("news.newsId").getValue();var d=App.createUploadDialog({file_cat:"info/news",callback:function(g){c.setValue(g[0].filePath);f.body.update('<img style="border:0;"  src="'+__ctxPath+"/attachFiles/"+g[0].filePath+'" border="0"/>');}});if(c.value!=""&&c.value!=null&&c.value!="undefined"){var e="再次上传需要先删除原有图片,";Ext.Msg.confirm("新闻确认",e+"是否删除？",function(g){if(g=="yes"){Ext.Ajax.request({url:__ctxPath+"/system/deleteFileAttach.do",method:"post",params:{filePath:c.value},success:function(){if(a!=""&&a!=null&&a!="undefined"){Ext.Ajax.request({url:__ctxPath+"/info/iconNews.do",method:"post",params:{newsId:a},success:function(){c.setValue("");f.body.update('<img style="border:0;"src="'+__ctxPath+'/images/default_newsIcon.jpg" border="0"/>');d.show("queryBtn");}});}else{c.setValue("");f.body.update('<img style="border:0;" src="'+__ctxPath+'/images/default_newsIcon.jpg" border="0"/>');d.show("queryBtn");}}});}});}else{d.show("queryBtn");}},section:function(a){new SectionSelector({callback:function(c,b){this.close();a.getCmpByName("news.sectionId").setValue(c);a.getCmpByName("sectionName").setValue(b);}}).show();}});